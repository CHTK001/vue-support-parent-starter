<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chua.starter.video.mapper.VideoInfoMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.chua.starter.video.entity.VideoInfo">
        <id column="video_id" property="videoId" />
        <result column="video_title" property="videoTitle" />
        <result column="video_description" property="videoDescription" />
        <result column="video_url" property="videoUrl" />
        <result column="video_cover" property="videoCover" />
        <result column="video_author" property="videoAuthor" />
        <result column="video_type" property="videoType" />
        <result column="video_platform" property="videoPlatform" />
        <result column="video_duration" property="videoDuration" />
        <result column="video_views" property="videoViews" />
        <result column="video_likes" property="videoLikes" />
        <result column="video_status" property="videoStatus" />
        <result column="create_time" property="createTime" />
        <result column="update_time" property="updateTime" />
    </resultMap>

    <!-- 搜索视频 -->
    <select id="searchVideos" resultMap="BaseResultMap">
        SELECT *
        FROM video_info
        WHERE video_status = 0
        <if test="request.keyword != null and request.keyword != ''">
            AND (
                video_title LIKE CONCAT('%', #{request.keyword}, '%')
                OR video_description LIKE CONCAT('%', #{request.keyword}, '%')
                OR video_author LIKE CONCAT('%', #{request.keyword}, '%')
            )
        </if>
        <if test="request.selectedType != null and request.selectedType != '' and request.selectedType != 'all'">
            AND EXISTS (
                SELECT 1 FROM video_type
                WHERE video_type.video_type_id = #{request.selectedType}
                AND video_info.video_type = video_type.video_type_name
            )
        </if>
        <if test="request.platformId != null and request.platformId != '' and request.platformId != 'all'">
            AND EXISTS (
                SELECT 1 FROM video_platform
                WHERE video_platform.video_platform_id = #{request.platformId}
                AND video_info.video_platform = video_platform.video_platform_name
            )
        </if>
        ORDER BY create_time DESC
    </select>
    
    <!-- 插入或更新视频信息 -->
    <insert id="insertOrUpdateVideo">
        INSERT INTO video_info (
            video_id, video_title, video_description, video_url, video_cover,
            video_author, video_type, video_platform, video_duration, video_views,
            video_likes, video_status
        ) VALUES (
            #{video.videoId}, #{video.videoTitle}, #{video.videoDescription}, #{video.videoUrl}, #{video.videoCover},
            #{video.videoAuthor}, #{video.videoType}, #{video.videoPlatform}, #{video.videoDuration}, #{video.videoViews},
            #{video.videoLikes}, #{video.videoStatus}
        ) ON DUPLICATE KEY UPDATE
            video_title = VALUES(video_title),
            video_description = VALUES(video_description),
            video_url = VALUES(video_url),
            video_cover = VALUES(video_cover),
            video_author = VALUES(video_author),
            video_type = VALUES(video_type),
            video_platform = VALUES(video_platform),
            video_duration = VALUES(video_duration),
            video_views = VALUES(video_views),
            video_likes = VALUES(video_likes),
            video_status = VALUES(video_status),
    </insert>
</mapper>