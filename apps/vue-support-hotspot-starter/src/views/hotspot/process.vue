<template>
  <div class="h-full">
    <div id="container" key="node" ref="echartsRef" height="100%" width="100%" class="h-full" />
  </div>
</template>
<script setup>
import { http } from "@repo/utils";
import { Graph } from "@antv/g6";
import { Md5 } from "ts-md5";

import { Circle } from "@antv/g6";
import { CubicHorizontal, ExtensionCategory, register, subStyleProps } from "@antv/g6";
import { onMounted, onUnmounted, ref } from "vue";

const heartbeatInterval = 30 * 1000; // 心跳间隔为30秒
const heartbeatTimeout = 60 * 1000; // 心跳超时时间为60秒
let heartbeatIntervalId, heartbeatTimeoutId;

// 心跳检测启动函数
const startHeartbeat = () => {
  heartbeatIntervalId = setInterval(function () {
    socketClient.value.send("ping"); // 发送心跳包

    // 重置心跳超时定时器
    clearTimeout(heartbeatTimeoutId);
    heartbeatTimeoutId = setTimeout(function () {
      console.log("Heartbeat timeout, closing the connection.");
      socketClient.value?.close(); // 超时未收到响应，关闭连接
      openSocket("ws://127.0.0.1:" + window.websocketPort);
      // 这里可以添加重新连接的逻辑
    }, heartbeatTimeout);
  }, heartbeatInterval);
};

const handleOpen = () => {
  console.log("WebSocket connection established.");
  startHeartbeat();
};

const handleClose = () => {
  console.log("WebSocket connection closed.");
  clearInterval(heartbeatIntervalId);
  clearTimeout(heartbeatTimeoutId);
};
// 判断消息是否为pong消息
function isPongMessage(message) {
  return message === "pong";
}

const handleEvent = async row => {
  try {
    row.data.text().then(data => {
      if (isPongMessage(data)) {
        // 重置心跳超时定时器
        return;
      }
      var item;
      try {
        item = JSON.parse(data);
      } catch (error) {}
      if ("AGENT_SERVER" !== item?.event) {
        return;
      }
      refresh(item?.data || {});
    });
  } catch (error) {
    return;
  }
};
const socketClient = ref();
const closeSocket = async () => {
  socketClient.value?.close();
  socketClient.value = null;
};

const openSocket = async urls => {
  closeSocket();
  socketClient.value = new WebSocket(urls);
  socketClient.value.onmessage = handleEvent;
  socketClient.value.onopen = handleOpen;
  socketClient.value.onclose = handleClose;
};

onMounted(async () => {
  openSocket("ws://127.0.0.1:" + window.websocketPort);
});
onUnmounted(() => {
  closeSocket();
});

class FlyMarkerCubic extends CubicHorizontal {
  getMarkerStyle(attributes) {
    return { r: 5, fill: "#c3d5f9", offsetPath: this.shapeMap.key, ...subStyleProps(attributes, "marker") };
  }

  onCreate() {
    const marker = this.upsert("marker", Circle, this.getMarkerStyle(this.attributes), this);
    marker.animate([{ offsetDistance: 0 }, { offsetDistance: 1 }], {
      duration: 3000,
      iterations: Infinity
    });
  }
}

register(ExtensionCategory.EDGE, "fly-marker-cubic", FlyMarkerCubic);

const graph = {
  value: null
};
const initialContainer = () => {
  const container = document.getElementById("container");
  const width = container.scrollWidth;
  const height = container.scrollHeight || 500;
  graph.value = new Graph({
    container: "container",
    width,
    height,
    behaviors: ["drag-canvas", "zoom-canvas", "drag-element"],
    layout: {
      type: "force",
      linkDistance: 200,
      clustering: true,
      nodeClusterBy: "cluster",
      clusterNodeStrength: 70
    },
    edge: {
      type: "fly-marker-cubic",
      style: {
        lineDash: [10, 10]
      }
    },
    node: {
      type: "html",
      style: {
        labelText: d => d.name,
        labelFill: "#000",
        ports: [],
        innerHTML: d => {
          const type = d.type;
          const width = 24;
          const newWidth = Math.min(8 * d.count + width, 64);
          if (type == "HTTP") {
            return `<div>
              <div>
                <svg xmlns="http://www.w3.org/2000/svg" width="${newWidth}" height="${newWidth}" viewBox="0 0 512 512"><mask id="circleFlagsEarth0"><circle cx="256" cy="256" r="256" fill="#fff"/></mask><g mask="url(#circleFlagsEarth0)"><path fill="#0052b4" d="M0 0h512v512H0z"/><path fill="#eee" d="M302.7 233.7a103.1 103.1 0 0 0 0 206a103.1 103.1 0 0 0 0-206m0 20c46 0 83 37 83 83s-37 83-83 83s-83-37-83-83s37-83 83-83"/><path fill="#eee" d="M209.4 72.3a103.1 103.1 0 0 0 0 206a103.1 103.1 0 0 0 0-206m0 20c46 0 83 37 83 83s-37 83-83 83s-83-37-83-83s37-83 83-83"/><path fill="#eee" d="M302.7 72.3a103.1 103.1 0 0 0 0 206a103.1 103.1 0 0 0 0-206m0 20c46 0 83 37 83 83s-37 83-83 83s-83-37-83-83s37-83 83-83"/><path fill="#eee" d="M349.2 153a103.1 103.1 0 0 0 0 206a103.1 103.1 0 0 0 0-206m0 20c46 0 83 37 83 83s-37 83-83 83s-83-37-83-83s37-83 83-83"/><path fill="#eee" d="M209.4 233.7a103.1 103.1 0 0 0 0 206a103.1 103.1 0 0 0 0-206m0 20c46 0 83 37 83 83s-37 83-83 83s-83-37-83-83s37-83 83-83"/><path fill="#eee" d="M162.8 153a103.1 103.1 0 0 0 0 206a103.1 103.1 0 0 0 0-206m0 20c46 0 83 37 83 83s-37 83-83 83s-83-37-83-83s37-83 83-83"/><path fill="#eee" d="M256 153.1a103.1 103.1 0 0 0 0 206a103.1 103.1 0 0 0 0-206m0 20c46 0 83 37 83 83c0 45.9-37 83-83 83s-83-37.1-83-83c0-46 37-83 83-83"/></g></svg>
                </div>
              <div class="text-white-500" style="text-align:center; width:60px; margin-left:15px">http</div>
              <div class="text-white-500" style="text-align:center; width:40px;">${d.name}</div>
              </div>`;
          }
          if (type == "NETTY") {
            return `<div>
              <div>
                <svg class="icon" width="${newWidth}" height="${newWidth}" style="vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3376"><path d="M566.816 128c154.784 48.864 267.008 193.536 267.008 364.48 0 211.04-171.072 382.144-382.176 382.144a381.12 381.12 0 0 1-134.144-24.224c1.376-9.376 3.04-18.752 4.992-26.464 6.56-25.856 84.192-53.536 95.68-58.784 11.52-5.216 44.992-36.608 70.08-47.072 25.12-10.464 50.24-11.52 84.736 2.08 30.944 12.192 54.4 65.568 58.976 76.512l0.8 1.984c13.728-53.344-49.28-94.176-89.056-127.68-39.744-33.472-58.56-73.184-61.696-146.4-3.136-73.248 42.88-128.704 67.04-168.448 24.128-39.712 41.728-99.36 20.224-131.776-21.536-32.448-21.376-54.4-19.424-73.792 0.864-8.64 8.64-16.48 16.96-22.56zM917.12 276.128l4.384 0.16c41.28 266.432-125.6 456.832-173.6 505.344l-3.2 3.168c-5.952 5.92-9.408 8.96-9.408 8.96v0.416c-0.128 2.112-2.464 10.816-28.608 35.136-30.688 28.608-84.096 20.672-84.096 20.672 28.384-12.736 55.168-28.8 79.776-47.872 0 0 58.144-42.88 113.12-149.92 77.792-151.552 54.048-300 52.544-308.736l-0.032-0.224 1.792 6.88c32.8 131.776-25.504 267.328-47.072 311.072l-2.176 4.32c-2.688 5.312-4.544 8.64-5.184 9.792l-0.224 0.416c133.824-198.72 105.12-382.176 102.208-398.432l-0.16-0.864-0.064-0.32zM451.68 136.832c29.696-0.032 59.264 3.648 88 10.976a26.208 26.208 0 0 0-0.192 1.696c-2.08 20.48-2.336 45.312 21.12 80.64 10.784 16.32 11.104 51.584-5.728 91.712a805.216 805.216 0 0 0-92.736-54.624c-62.752-31.392-138.592-56.48-144.64-54.4-5.984 2.08-12.256 36.608-4.96 48.128 7.328 11.52 100.416 50.208 72.192 137.024-28.224 86.816-21.984 167.36 47.072 218.624 29.952 22.272 65.824 40.96 96.832 54.976 2.688 2.56 5.504 5.024 8.352 7.424 5.376 4.512 11.04 9.056 16.992 13.888 6.688 5.344 13.536 10.88 20.192 16.512a148.704 148.704 0 0 0-35.2-8.96 86.272 86.272 0 0 0-41.28-16.896c-46.016-6.272-82.624 2.08-110.88 16.736-28.224 14.656-23.36 16.736-77.568 11.52-50.336-4.864-77.376 14.624-80.992 17.472l-0.416 0.32s42.016 47.776 92.8 77.216a36.864 36.864 0 0 0-7.808 13.184A355.712 355.712 0 0 1 96 492.48C96 296 255.232 136.8 451.68 136.8z" p-id="3377"></path></svg>
                </div>
              <div class="text-white-500" style="text-align:center; width:60px; margin-left:15px">netty</div>
              <div class="text-white-500" style="text-align:center; width:40px;">${d.name}</div>
              </div>`;
          }
          if (type == "KAFKA") {
            return `<div>
              <div>
                <svg xmlns="http://www.w3.org/2000/svg" width="${newWidth}" height="${newWidth}" viewBox="0 0 256 256"><g fill="none"><rect width="256" height="256" fill="#a9cbd4" rx="60"/><g clip-path="url(#skillIconsKafka0)"><path fill="#000" d="M162.998 138.677c-7.78 0-14.754 3.447-19.53 8.873l-12.238-8.664c1.299-3.576 2.045-7.417 2.045-11.437c0-3.95-.72-7.727-1.976-11.25l12.21-8.572c4.776 5.398 11.732 8.826 19.489 8.826c14.358 0 26.042-11.681 26.042-26.042c0-14.36-11.684-26.042-26.042-26.042S136.956 76.05 136.956 90.41c0 2.57.388 5.049 1.085 7.396l-12.219 8.577a33.6 33.6 0 0 0-20.827-12.103V79.554c11.796-2.477 20.685-12.958 20.685-25.482c0-14.36-11.684-26.042-26.043-26.042S73.596 39.71 73.596 54.072c0 12.356 8.658 22.708 20.219 25.362v14.918C78.037 97.122 66 110.89 66 127.449c0 16.64 12.156 30.459 28.047 33.134v15.752c-11.679 2.567-20.452 12.982-20.452 25.422c0 14.361 11.684 26.043 26.043 26.043s26.042-11.682 26.042-26.043c0-12.44-8.773-22.855-20.452-25.422v-15.752a33.63 33.63 0 0 0 20.475-11.908l12.32 8.72a26 26 0 0 0-1.067 7.325c0 14.36 11.683 26.042 26.042 26.042c14.358 0 26.042-11.682 26.042-26.042s-11.684-26.043-26.042-26.043m0-60.892c6.963 0 12.626 5.665 12.626 12.626s-5.663 12.626-12.626 12.626s-12.626-5.665-12.626-12.626s5.663-12.626 12.626-12.626M87.011 54.072c0-6.96 5.664-12.626 12.627-12.626c6.962 0 12.626 5.665 12.626 12.626S106.6 66.698 99.638 66.698c-6.963 0-12.627-5.665-12.627-12.626m25.253 147.685c0 6.961-5.664 12.626-12.626 12.626c-6.963 0-12.627-5.665-12.627-12.626s5.664-12.626 12.627-12.626c6.962 0 12.626 5.666 12.626 12.626m-12.627-56.699c-9.711 0-17.612-7.898-17.612-17.609s7.9-17.611 17.611-17.611s17.611 7.9 17.611 17.611s-7.9 17.609-17.61 17.609m63.361 32.288c-6.963 0-12.626-5.666-12.626-12.626c0-6.961 5.663-12.626 12.626-12.626s12.626 5.665 12.626 12.626s-5.663 12.626-12.626 12.626"/></g><defs><clipPath id="skillIconsKafka0"><path fill="#fff" d="M66 28h123.04v200H66z"/></clipPath></defs></g></svg>
                </div>
              <div class="text-white-500" style="text-align:center; width:60px; margin-left:15px">kafka</div>
              <div class="text-white-500" style="text-align:center; width:40px;">${d.name}</div>
              </div>`;
          }
          if (type == "DUBBO" || type == "RPC") {
            return `<div>
              <div>
                <svg xmlns="http://www.w3.org/2000/svg" width="${newWidth}" height="${newWidth}" viewBox="0 0 128 128"><path fill="#398ccb" d="M0 38C0 17 17 0 38 0h52c21 0 38 17 38 38v52c0 21-17 38-38 38H38c-21 0-38-17-38-38z"/><path fill="#fff" d="M63.9 18.8L81.6 29v5.6l21.5 12.5v21.2l5.8 3.3v20.6l-17.7 10.2l-7.9-4.6l-19.2 11.1l-19.1-11l-7.7 4.5l-17.8-10.3V71.6l5.6-3.2V47.1l21-12.2V29zM81.7 40v9.6L63.9 59.8L46.2 49.6v-9.3l-16.5 9.5v16l7.6-4.4l17.8 10.3v20.5l-5.4 3.1l14.5 8.3l14.5-8.4l-5.3-3V71.7l17.8-10.3l7.4 4.3V49.8zm7.2 55.8V83.2L78.1 77v12.5zM104.3 77l-10.8 6.3v12.5l10.8-6.3zM35 95.8V83.3L24.1 77v12.5zm15.5-18.7l-10.8 6.2v12.5l10.8-6.2zm40.7 2.3l10.9-6.3l-10.9-6.2l-10.8 6.2zM37.3 66.9l-10.8 6.2l10.8 6.3l10.8-6.3zm24.3-13.6V40.8l-10.8-6.2v12.5zm15.5-18.8l-10.9 6.3v12.5L77.1 47zm-13.2 2.3l10.9-6.3l-10.9-6.2l-10.8 6.2z"/></svg>
                </div>
              <div class="text-white-500" style="text-align:center; width:60px; margin-left:15px">rpc</div>
              <div class="text-white-500" style="text-align:center; width:40px;">${d.name}</div>
              </div>`;
          }
          if (type == "RABBIT") {
            return `<div>
              <div>
                <svg xmlns="http://www.w3.org/2000/svg" width="${newWidth}" height="${newWidth}" viewBox="0 0 128 128"><path fill="#f60" d="M119.517 51.188H79.291a3.64 3.64 0 0 1-3.64-3.642V5.62A5.605 5.605 0 0 0 70.028 0H55.66a5.606 5.606 0 0 0-5.627 5.62v41.646a3.913 3.913 0 0 1-3.92 3.925l-13.188.047c-2.176 0-3.972-1.75-3.926-3.926l.094-41.687A5.606 5.606 0 0 0 23.467 0H9.1a5.61 5.61 0 0 0-5.626 5.625V122.99c0 2.737 2.22 5.01 5.01 5.01h111.033a5.014 5.014 0 0 0 5.008-5.011V56.195a4.975 4.975 0 0 0-5.008-5.007M100.66 95.242a6.545 6.545 0 0 1-6.525 6.524H82.791a6.545 6.545 0 0 1-6.523-6.524V83.9a6.545 6.545 0 0 1 6.523-6.524h11.343a6.545 6.545 0 0 1 6.525 6.523zm0 0"/></svg>
                </div>
              <div class="text-white-500" style="text-align:center; width:60px; margin-left:15px">rabbitmq</div>
              <div class="text-white-500" style="text-align:center; width:40px;">${d.name}</div>
              </div>`;
          }
          if (type == "ZOOKEEPER") {
            return `<div>
              <div>
                <svg xmlns="http://www.w3.org/2000/svg" width="${newWidth}" height="${newWidth}"  viewBox="0 0 24 24"><g fill="none"><path fill="#9c63d6" d="m13.165 12.626l-.875-.894a.1.1 0 0 1-.018-.062q-.002-.019.005-.034a.1.1 0 0 1 .02-.029l.874-.856h1.65q.096.002.032-.063C12.347 8.213 9.822 6.051 7.29 3.532c-.437-.437-.25-1.137.25-1.412c.438-.25.863-.081 1.194.25c3 2.969 6.019 5.625 9.056 8.625c.425.43.387 1.187-.162 1.468c-.144.075-.4.163-.757.163z"/><path fill="#1f1f1f" d="M9.534 2.645c.175-.956 1.868-.85 1.843.337v1.42l-.012.024a.04.04 0 0 1-.038.013l-.025-.007A93 93 0 0 0 9.71 2.89a1 1 0 0 1-.175-.207s-.013.007 0-.037m4.718 4.406a.08.08 0 0 1-.025-.056a.08.08 0 0 1 .025-.057l4.875-4.618c.184-.182.43-.289.688-.3c.124 0 .25.019.362.062a1 1 0 0 1 .306.194l.006.013a.87.87 0 0 1 .257.656a.98.98 0 0 1-.3.681L15.57 8.245a.08.08 0 0 1-.112 0zm-1.437 3.6l-.981.987a.08.08 0 0 0-.025.063a.08.08 0 0 0 .025.062l.887.857c2.563 2.5 5.112 5.28 7.65 7.737c.944.912-.363 2.25-1.306 1.33c-2.525-2.455-5.075-5.243-7.65-7.749l-.013-.012c-.03 0-.025.012-.025.031v3.212c0 .075-.043.088-.1.032l-1.625-1.575a.45.45 0 0 1-.15-.338V6.151c0-.05.02-.056.05-.025l1.757 1.712a.1.1 0 0 1 .037.057c.013.018.031.043.031.062V9.37c0 .087.02.1.082.037l.762-.775a.06.06 0 0 1 .044-.019q.025 0 .044.02l1.237 1.2c.031.037.031.068 0 .105l-.725.713z"/><path fill="#9c63d6" d="M9.171 10.75v1.876H6.484q-.066 0-.02.037c2.47 2.45 4.963 5.206 7.482 7.687q.298.3.344.657c.05.45-.288.868-.725.968a.94.94 0 0 1-.907-.28c-3.05-3.026-6.093-6.332-9.13-9.332a.92.92 0 0 1 .043-1.35c.213-.178.485-.272.763-.262z"/><path fill="#1f1f1f" d="m9.502 19.15l.007-.025c0-.006 0-.012.012-.018a.04.04 0 0 1 .05 0c.588.581 1.156 1.137 1.713 1.669c.093.087.118.443.075.562a.958.958 0 0 1-1.532.425a.76.76 0 0 1-.312-.613z"/></g></svg>
                </div>
              <div class="text-white-500" style="text-align:center; width:60px; margin-left:15px">zookeeper</div>
              <div class="text-white-500" style="text-align:center; width:40px;">${d.name}</div>
              </div>`;
          }
          if (type == "CLIENT") {
            return `<div>
              <div>
                <svg xmlns="http://www.w3.org/2000/svg" width="${newWidth}" height="${newWidth}" viewBox="0 0 128 128"><path fill="#b7d5e5" d="M71.59 68.58H58.75c0 20.36-4.21 28.52-4.21 28.52H75.8c0-.01-4.21-8.17-4.21-28.52"/><path fill="#2f7889" d="M39.41 98.17c-.07-1.14.1-2.64.1-2.64s45.24-1.88 48.83-.09c0 0 .48 1.66.15 2.74c-.79 2.53-10.99 4.8-24.55 4.8s-24.37-2.16-24.53-4.81"/><ellipse cx="64" cy="95.96" fill="#b7d5e5" rx="24.55" ry="4.8"/><path fill="#69a1ba" d="M71.59 68.58H58.75c0 6.64-.45 11.98-1.05 16.16l15.31 2.3c-.78-4.47-1.42-10.54-1.42-18.46"/><path fill="#eee" d="M55.49 91.46s-3.72 1.52-2.88 2.63c1.3 1.74 4.93 2.83 13.71 3.42c6.17.41 3.75 2.13-2.05 2.48c-4.07.24-23.58.4-24.74-3.67c-.94-3.31 13.18-4.86 15.96-4.86m43.91 15.05H28.49c-.97 0-1.94.54-2.48 1.4l-7.78 10.7c-.72.98-.01 2.36 1.2 2.36h89.13c1.22 0 1.92-1.38 1.2-2.36l-7.88-10.8c-.53-.76-1.5-1.3-2.48-1.3"/><path fill="#69a1ba" d="M35.61 111.26h-4.86l.65-1.18h4.86zm7.67 0h-4.86l.54-1.18h5.07zm7.34 0h-4.97l.76-1.18h4.85zm7.23 0h-4.86l.76-1.18h4.64zm7.23 0h-4.97l.44-1.18h4.1zm7.23 0h-4.86l-.54-1.18h4.65zm7.56 0H74.9l-.86-1.18h4.86zm7.23 0h-4.97l-.86-1.18h4.97zm9.82 0h-7.45l-.86-1.18h7.56zm-3.78 1.95H98l-.86-1.3h-4.97zm-7.98 0h4.85l-.97-1.3h-4.86zm-7.34 0h4.85l-.75-1.3h-4.97zm-7.88 0h4.85l-.86-1.3h-4.64zm-7.02 0h4.86l-.54-1.3h-4.1zm-7.02 0h4.86l.33-1.3h-4.75zm-7.66 0h4.86l.65-1.3H49zm-8.63 0h4.96l.76-1.3h-4.97zm-9.93 0h7.34l.75-1.3h-7.45zm46.41 1.94h4.96l-.86-1.3h-4.96zm-7.77 0h4.85l-.64-1.3h-4.64zm-9.29 0H64l-.11-1.3h-4.42zm-8.74 0h4.97l.43-1.3h-4.75zm-9.17 0h4.85l.76-1.3h-4.86zm-12.42 0h9.83l.75-1.3h-9.82zm55.7 0h14.68l-.86-1.3H83.54zm11.12 1.94h4.96l-.97-1.29h-4.96zm-9.07 0h4.86l-.97-1.29h-4.86zm-39.18 0h33.35l-.75-1.29H48.02zm-10.47 0h4.96l.54-1.29h-4.75zm-9.28 0h4.85l.54-1.29h-4.75z" opacity="0.57"/><path fill="#2f7889" d="M108.69 124H19.31c-.88 0-1.64-.76-1.64-1.62v-2.4h92.68v2.4c-.01.86-.78 1.62-1.66 1.62"/><path fill="#b7d5e5" d="M99.4 107.52c.61 0 1.3.36 1.67.88l8.22 11.27c.05.06.05.13.02.2c-.04.07-.09.1-.17.1H18.86c-.08 0-.13-.03-.17-.1a.17.17 0 0 1 .02-.2l8.12-11.16l.02-.03l.02-.03c.35-.57.99-.93 1.63-.93zm0-1.01H28.49c-.97 0-1.94.54-2.48 1.4l-8.12 11.16c-.57.79-.01 1.9.97 1.9h90.29c.98 0 1.54-1.11.97-1.9l-8.22-11.27c-.55-.75-1.52-1.29-2.5-1.29"/><path fill="#69a1ba" d="M113.46 79.66H14.54a3.44 3.44 0 0 1-3.44-3.44v-67c0-1.9 1.54-3.44 3.44-3.44h98.91c1.9 0 3.44 1.54 3.44 3.44v67c.01 1.9-1.53 3.44-3.43 3.44"/><path fill="#b7d5e5" d="M113.46 77.89H14.54a3.44 3.44 0 0 1-3.44-3.44v-67c0-1.9 1.54-3.44 3.44-3.44h98.91c1.9 0 3.44 1.54 3.44 3.44v67a3.43 3.43 0 0 1-3.43 3.44"/><radialGradient id="notoDesktopComputer0" cx="46.465" cy="-5.176" r="60.973" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#2f7889"/><stop offset="1" stop-color="#424242"/></radialGradient><path fill="url(#notoDesktopComputer0)" d="M15.25 9.38h97.5V72.5h-97.5z"/><path fill="none" stroke="#eee" stroke-linecap="round" stroke-miterlimit="10" stroke-width="3.01" d="M16.39 6.99h11.19"/></svg>
                </div>
              <div class="text-white-500" style="text-align:center; width:60px; margin-left:15px">客户端</div>
              <div class="text-white-500" style="text-align:center; width:40px;">${d.name}</div>
              </div>`;
          }
          if (type == "HOST") {
            return `<div>
              <div>
                <svg xmlns="http://www.w3.org/2000/svg" width="${newWidth}" height="${newWidth}" viewBox="0 0 64 64"><path fill="#243438" d="M13.596 25.06v-6.459c0-.053-.021-.1-.049-.1H10.32c-.027 0-.051.047-.051.1v6.459c0 .028.008.051.012.067l.004.003h.004c.004.016.018.027.031.027h3.227c.027 0 .049-.042.049-.097"/><path fill="#d1d2d3" d="M21.07 22.614H2.652c-.152 0-.277.021-.277.049v3.105c0 .027.125.047.277.047H21.07q.125 0 .191-.012l.008-.004h.006c.045-.006.074-.02.074-.032v-3.105c.001-.026-.126-.048-.279-.048"/><path fill="#a7a8ac" d="M23.273 24.21H.594c-.188 0-.344.027-.344.062v3.82c0 .036.156.061.344.061h22.679q.151 0 .234-.015l.008-.002c.004 0 .004-.004.008-.004c.054-.007.093-.019.093-.039v-3.82c.001-.036-.155-.063-.343-.063"/><path fill="#e7e6e6" d="M22.23 2.177H1.628c-.169 0-.312.123-.312.263v17.082c0 .145.143.266.312.266H22.23a.32.32 0 0 0 .215-.071l.008-.008l.006-.012a.22.22 0 0 0 .084-.176V2.439c0-.139-.141-.262-.313-.262"/><path fill="#d1d2d3" d="M21.678 3.148H2.773c-.156 0-.285.111-.285.242v15.67c0 .133.129.244.285.244h18.905q.126-.002.197-.062l.004-.01q.004-.001.008-.01a.2.2 0 0 0 .078-.162V3.39c0-.131-.131-.242-.287-.242"/><path fill="#57c6e9" d="M20.332 3.739H3.387c-.141 0-.258.1-.258.217v14.05c0 .119.117.219.258.219h16.945a.27.27 0 0 0 .176-.057s0-.005.004-.009q.004-.001.008-.008a.18.18 0 0 0 .068-.145V3.956c0-.117-.117-.217-.256-.217"/><path fill="#27a8e0" d="M12.184 13.13c2.832 2.167 5.599 3.639 8.48 4.531V3.957c0-.118-.117-.217-.258-.217H4.855c1.599 3.842 4.348 7.114 7.329 9.39m.019 2.299c-3.418-2.375-6.84-5.665-9-9.731v12.309c0 .119.117.219.258.219h13.832a27 27 0 0 1-5.09-2.797"/><path fill="#243438" d="M53.73 25.06v-6.459c0-.053-.023-.1-.051-.1h-3.227c-.023 0-.047.047-.047.1v6.459q0 .043.011.067l.002.003h.004c.007.016.02.027.03.027h3.227c.028 0 .051-.042.051-.097"/><path fill="#d1d2d3" d="M61.2 22.614H42.782c-.151 0-.277.021-.277.049v3.105c0 .027.126.047.277.047H61.2q.124 0 .192-.012l.007-.004h.008c.043-.006.074-.02.074-.032v-3.105c0-.026-.126-.048-.281-.048"/><path fill="#a7a8ac" d="M63.41 24.21H40.731c-.188 0-.342.027-.342.062v3.82c0 .036.154.061.342.061H63.41q.153 0 .235-.015l.007-.002c.004 0 .006-.004.006-.004c.057-.007.096-.019.096-.039v-3.82c0-.036-.155-.063-.344-.063"/><path fill="#e7e6e6" d="M62.37 2.177H41.769c-.172 0-.313.123-.313.264v17.082c0 .145.142.266.313.266h20.603a.32.32 0 0 0 .214-.071l.009-.008l.007-.012a.22.22 0 0 0 .082-.176V2.44c0-.14-.14-.263-.312-.263"/><path fill="#d1d2d3" d="M61.812 3.148H42.907c-.155 0-.285.111-.285.242v15.67c0 .133.13.244.285.244h18.905a.3.3 0 0 0 .195-.062s0-.004.004-.01q.005-.001.008-.01a.2.2 0 0 0 .079-.162V3.39c.001-.131-.129-.242-.286-.242"/><path fill="#57c6e9" d="M60.47 3.739H43.525c-.141 0-.258.1-.258.217v14.05c0 .119.117.219.258.219H60.47a.27.27 0 0 0 .176-.057l.004-.009q.005-.001.009-.008a.2.2 0 0 0 .069-.145V3.956c0-.117-.117-.217-.258-.217"/><path fill="#27a8e0" d="M52.32 13.13c2.832 2.167 5.602 3.639 8.48 4.531V3.957c0-.118-.116-.217-.258-.217H44.994c1.596 3.842 4.346 7.114 7.326 9.39m.02 2.299c-3.42-2.375-6.841-5.665-9-9.731v12.309c0 .119.119.219.258.219h13.833a27 27 0 0 1-5.089-2.797"/><path fill="#243438" d="M32.943 61.02v-6.458c0-.055-.023-.102-.051-.102h-3.224c-.028 0-.051.047-.051.102v6.458c0 .027.008.051.012.065l.004.004h.001c.006.016.02.028.034.028h3.224c.028 0 .051-.043.051-.097"/><path fill="#d1d2d3" d="M40.41 58.58H21.992c-.152 0-.279.019-.279.047v3.105c0 .028.127.047.279.047H40.41q.123 0 .191-.011q.001.001.008-.004h.004c.047-.009.076-.02.076-.032v-3.105c0-.028-.127-.047-.279-.047"/><path fill="#a7a8ac" d="M42.619 60.17H19.942c-.188 0-.344.026-.344.062v3.821c0 .036.156.062.344.062h22.677q.152-.001.236-.016c.004 0 .004-.004.008-.004q.001.001.008-.004c.056-.007.092-.02.092-.039v-3.821c0-.035-.154-.061-.344-.061"/><path fill="#e7e6e6" d="M41.582 38.14H20.98c-.172 0-.312.121-.312.263v17.081c0 .145.141.266.312.266h20.6a.33.33 0 0 0 .216-.068l.005-.01s.006-.007.008-.012a.22.22 0 0 0 .085-.176V38.403c0-.142-.142-.263-.314-.263"/><path fill="#d1d2d3" d="M41.02 39.1H22.116c-.156 0-.285.112-.285.242v15.671c0 .134.129.242.285.242h18.905c.084 0 .15-.023.197-.06c0 0 0-.006.004-.01c.004 0 .004-.009.009-.013a.2.2 0 0 0 .077-.16V39.341c-.001-.128-.133-.241-.288-.241"/><path fill="#57c6e9" d="M39.678 39.698H22.735c-.141 0-.258.102-.258.218v14.05c0 .118.117.216.258.216h16.943a.26.26 0 0 0 .176-.055l.006-.011q.005 0 .008-.009a.18.18 0 0 0 .069-.142V39.914c0-.114-.121-.216-.259-.216"/><path fill="#27a8e0" d="M31.532 49.09c2.832 2.167 5.599 3.64 8.48 4.533V39.919c0-.116-.117-.218-.258-.218H24.203c1.598 3.841 4.348 7.114 7.329 9.389m.019 2.3c-3.418-2.373-6.84-5.663-9-9.729v12.31c0 .118.117.216.258.216h13.83a26.6 26.6 0 0 1-5.088-2.797"/><path fill="#58595b" d="M41.04 11.226c0 .916-.746 1.66-1.662 1.66H24.831a1.66 1.66 0 1 1 0-3.32h14.547c.916 0 1.662.742 1.662 1.66M55.82 31.05c.73.555.866 1.6.308 2.329l-8.86 11.537a1.661 1.661 0 1 1-2.635-2.022l8.859-11.539a1.66 1.66 0 0 1 2.328-.305m-49.404 0a1.663 1.663 0 0 0-.305 2.329l8.861 11.537a1.659 1.659 0 1 0 2.633-2.022l-8.859-11.54a1.664 1.664 0 0 0-2.33-.304"/></svg>
                </div>
              <div class="text-white-500" style="text-align:center; width:60px; margin-left:15px">服务器</div>
              <div class="text-white-500" style="text-align:center; width:40px;" >${d.name}</div>
              </div>`;
          }
          if (type == "MYSQL") {
            return `<div>
              <div><svg xmlns="http://www.w3.org/2000/svg" width="${newWidth}" height="${newWidth}" viewBox="0 0 128 128"><path fill="#00618a" d="M117.688 98.242c-6.973-.191-12.297.461-16.852 2.379c-1.293.547-3.355.559-3.566 2.18c.711.746.82 1.859 1.387 2.777c1.086 1.754 2.922 4.113 4.559 5.352c1.789 1.348 3.633 2.793 5.551 3.961c3.414 2.082 7.223 3.27 10.504 5.352c1.938 1.23 3.859 2.777 5.75 4.164c.934.684 1.563 1.75 2.773 2.18v-.195c-.637-.812-.801-1.93-1.387-2.777l-2.578-2.578c-2.52-3.344-5.719-6.281-9.117-8.719c-2.711-1.949-8.781-4.578-9.91-7.73l-.199-.199c1.922-.219 4.172-.914 5.949-1.391c2.98-.797 5.645-.59 8.719-1.387l4.164-1.187v-.793c-1.555-1.594-2.664-3.707-4.359-5.152c-4.441-3.781-9.285-7.555-14.273-10.703c-2.766-1.746-6.184-2.883-9.117-4.363c-.988-.496-2.719-.758-3.371-1.586c-1.539-1.961-2.379-4.449-3.566-6.738c-2.488-4.793-4.93-10.023-7.137-15.066c-1.504-3.437-2.484-6.828-4.359-9.91c-9-14.797-18.687-23.73-33.695-32.508c-3.195-1.867-7.039-2.605-11.102-3.57l-6.543-.395c-1.332-.555-2.715-2.184-3.965-2.977C16.977 3.52 4.223-3.312.539 5.672C-1.785 11.34 4.016 16.871 6.09 19.746c1.457 2.012 3.32 4.273 4.359 6.539c.688 1.492.805 2.984 1.391 4.559c1.438 3.883 2.695 8.109 4.559 11.695c.941 1.816 1.98 3.727 3.172 5.352c.727.996 1.98 1.438 2.18 2.973c-1.227 1.715-1.297 4.375-1.984 6.543c-3.098 9.77-1.926 21.91 2.578 29.137c1.383 2.223 4.641 6.98 9.117 5.156c3.918-1.598 3.043-6.539 4.164-10.902c.254-.988.098-1.715.594-2.379v.199l3.57 7.133c2.641 4.254 7.324 8.699 11.297 11.699c2.059 1.555 3.68 4.242 6.344 5.152v-.199h-.199c-.516-.805-1.324-1.137-1.98-1.781c-1.551-1.523-3.277-3.414-4.559-5.156c-3.613-4.902-6.805-10.27-9.711-15.855c-1.391-2.668-2.598-5.609-3.77-8.324c-.453-1.047-.445-2.633-1.387-3.172c-1.281 1.988-3.172 3.598-4.164 5.945c-1.582 3.754-1.789 8.336-2.375 13.082c-.348.125-.195.039-.398.199c-2.762-.668-3.73-3.508-4.758-5.949c-2.594-6.164-3.078-16.09-.793-23.191c.59-1.836 3.262-7.617 2.18-9.316c-.516-1.691-2.219-2.672-3.172-3.965c-1.18-1.598-2.355-3.703-3.172-5.551c-2.125-4.805-3.113-10.203-5.352-15.062c-1.07-2.324-2.875-4.676-4.359-6.738c-1.645-2.289-3.484-3.977-4.758-6.742c-.453-.984-1.066-2.559-.398-3.566c.215-.684.516-.969 1.191-1.191c1.148-.887 4.352.297 5.547.793c3.18 1.32 5.832 2.578 8.527 4.363c1.289.855 2.598 2.512 4.16 2.973h1.785c2.789.641 5.914.195 8.523.988c4.609 1.402 8.738 3.582 12.488 5.949c11.422 7.215 20.766 17.48 27.156 29.734c1.027 1.973 1.473 3.852 2.379 5.945c1.824 4.219 4.125 8.559 5.941 12.688c1.816 4.113 3.582 8.27 6.148 11.695c1.348 1.801 6.551 2.766 8.918 3.766c1.66.699 4.379 1.43 5.949 2.379c3 1.809 5.906 3.965 8.723 5.945c1.402.992 5.73 3.168 5.945 4.957zm-88.605-75.52c-1.453-.027-2.48.156-3.566.395v.199h.195c.695 1.422 1.918 2.34 2.777 3.566l1.98 4.164l.199-.195c1.227-.867 1.789-2.25 1.781-4.363c-.492-.52-.562-1.164-.992-1.785c-.562-.824-1.66-1.289-2.375-1.98zm0 0"/></svg></div>
              <div class="text-white-500" style="text-align:center; width:40px; margin-left:15px">mysql</div>
              <div class="text-white-500" style="text-align:center; width:40px;" >${d.name}</div>
              </div>`;
          }
          if (type == "REDIS") {
            return `<div>
              <div><svg xmlns="http://www.w3.org/2000/svg" width="${newWidth}" height="${newWidth}" viewBox="0 0 128 128"><path fill="#a41e11" d="M121.8 93.1c-6.7 3.5-41.4 17.7-48.8 21.6s-11.5 3.8-17.3 1S13 98.1 6.3 94.9c-3.3-1.6-5-2.9-5-4.2V78s48-10.5 55.8-13.2c7.8-2.8 10.4-2.9 17-.5s46.1 9.5 52.6 11.9v12.5c0 1.3-1.5 2.7-4.9 4.4"/><path fill="#d82c20" d="M121.8 80.5C115.1 84 80.4 98.2 73 102.1s-11.5 3.8-17.3 1S13 85.4 6.3 82.2C-.3 79-.5 76.8 6 74.3c6.5-2.6 43.2-17 51-19.7c7.8-2.8 10.4-2.9 17-.5s41.1 16.1 47.6 18.5c6.7 2.4 6.9 4.4.2 7.9"/><path fill="#a41e11" d="M121.8 72.5C115.1 76 80.4 90.2 73 94.1c-7.4 3.8-11.5 3.8-17.3 1S13 77.4 6.3 74.2c-3.3-1.6-5-2.9-5-4.2V57.3s48-10.5 55.8-13.2c7.8-2.8 10.4-2.9 17-.5s46.1 9.5 52.6 11.9V68c0 1.3-1.5 2.7-4.9 4.5"/><path fill="#d82c20" d="M121.8 59.8c-6.7 3.5-41.4 17.7-48.8 21.6c-7.4 3.8-11.5 3.8-17.3 1S13 64.7 6.3 61.5s-6.8-5.4-.3-7.9c6.5-2.6 43.2-17 51-19.7c7.8-2.8 10.4-2.9 17-.5s41.1 16.1 47.6 18.5c6.7 2.4 6.9 4.4.2 7.9"/><path fill="#a41e11" d="M121.8 51c-6.7 3.5-41.4 17.7-48.8 21.6c-7.4 3.8-11.5 3.8-17.3 1C49.9 70.9 13 56 6.3 52.8c-3.3-1.6-5.1-2.9-5.1-4.2V35.9s48-10.5 55.8-13.2c7.8-2.8 10.4-2.9 17-.5s46.1 9.5 52.6 11.9v12.5c.1 1.3-1.4 2.6-4.8 4.4"/><path fill="#d82c20" d="M121.8 38.3C115.1 41.8 80.4 56 73 59.9c-7.4 3.8-11.5 3.8-17.3 1S13 43.3 6.3 40.1s-6.8-5.4-.3-7.9c6.5-2.6 43.2-17 51-19.7c7.8-2.8 10.4-2.9 17-.5s41.1 16.1 47.6 18.5c6.7 2.4 6.9 4.4.2 7.8"/><path fill="#fff" d="m80.4 26.1l-10.8 1.2l-2.5 5.8l-3.9-6.5l-12.5-1.1l9.3-3.4l-2.8-5.2l8.8 3.4l8.2-2.7L72 23zM66.5 54.5l-20.3-8.4l29.1-4.4z"/><ellipse cx="38.4" cy="35.4" fill="#fff" rx="15.5" ry="6"/><path fill="#7a0c00" d="m93.3 27.7l17.2 6.8l-17.2 6.8z"/><path fill="#ad2115" d="m74.3 35.3l19-7.6v13.6l-1.9.8z"/></svg></div>
              <div class="text-white-500" style="text-align:center; width:40px; margin-left:15px">redis</div>
              <div class="text-white-500" style="text-align:center; width:40px;">${d.name}</div>
              </div>`;
          }
          return `<span><span class="icon-[logos--redis]"></span></span>`;
        }
      },
      palette: {
        type: "group",
        field: "cluster"
      }
    },
    defaultNode: {
      color: "#5B8FF9"
    },
    modes: {
      default: ["drag-canvas", "drag-element", "zoom-canvas"]
    }
  });
  initial();
};
const initial = async () => {
  http.request("get", (window.agentPath || "/agent") + "/server_info", {}).then(res => {
    update(res?.response?.data);
  });
};
onMounted(async () => {
  initialContainer();
});
const refresh = async data => {
  data.id = Md5.hashStr(data.sourceHost + data.sourcePort + data.targetHost + data.targetPort);
  const sourceNodeId = Md5.hashStr(data.sourceHost + data.sourcePort);
  const targetNodeId = Md5.hashStr(data.targetHost + data.targetPort);
  let nodes = [...graph.value.getNodeData()],
    edges = [];
  if (!graph.value.getNodeData(sourceNodeId)) {
    nodes.push({
      id: sourceNodeId,
      type: data.sourceName,
      name: data.sourceHost + ":" + data.sourcePort,
      data: data,
      count: 1
    });
  }
  if (!graph.value.getNodeData(targetNodeId)) {
    nodes.push({
      id: targetNodeId,
      type: data.name,
      name: data.targetHost + ":" + data.targetPort,
      data: data,
      count: data.count
    });
  }
  edges = [
    ...graph.value.getEdgeData(),
    {
      source: sourceNodeId,
      target: targetNodeId
    }
  ];

  graph.value.setData({
    nodes,
    edges
  });
};
const update = async data => {
  data.forEach(item => {
    refresh(item);
  });
  graph.value.render();
};
</script>
