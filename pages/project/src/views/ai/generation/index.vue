<template>
  <div class="ai-generator-layout">
    <!-- ÂØπËØùÊ°ÜÁªÑ‰ª∂ -->
    <ModuleUpdateDialog ref="moduleUpdateDialogRef" @success="handleRefreshEnvironment"></ModuleUpdateDialog>
    <ModuleDialog ref="moduleDialogRef" @success="handleRefreshEnvironment" @handleRefreshEnvironmentTemplate="handleRefreshEnvironmentTemplate"></ModuleDialog>

    <!-- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü -->
    <div class="main-content">
      <!-- ÂéÜÂè≤ËÆ∞ÂΩïÂå∫ÂüüÔºàÂåÖÂê´Êñ∞ÁîüÊàêÁöÑÂÜÖÂÆπÔºâ -->
      <div class="history-section">
        <HistoryLayout ref="historyLayoutRef" :form="form" :full="true" :env="env" :new-generated-data="generatedResults" @redrawer="handleReDraw"></HistoryLayout>
      </div>
    </div>

    <!-- Â∫ïÈÉ®ËæìÂÖ•Âå∫Âüü -->
    <div class="bottom-input-area">
      <!-- ËÆæÁΩÆÈÄâÈ°πÊ†è -->
      <div class="settings-bar" v-if="showSettings">
        <el-scrollbar class="settings-scroll">
          <div class="settings-content">
            <!-- Ê®°ÂûãÈÄâÊã© -->
            <div class="setting-item">
              <label class="setting-label">Ê®°Âûã</label>
              <el-select v-model="form.model" placeholder="ÈÄâÊã©Ê®°Âûã" size="small" @change="handleChangeModule" class="compact-select">
                <el-option v-for="item in modelList" :key="item.sysAiModuleCode" :label="item.sysAiModuleName" :value="item.sysAiModuleCode">
                  <div class="model-option">
                    <el-image :src="item.sysProjectIcon" class="model-icon" />
                    <span>{{ item.sysAiModuleName }}</span>
                  </div>
                </el-option>
              </el-select>
            </div>

            <!-- ÊØî‰æãÈÄâÊã© -->
            <div class="setting-item">
              <label class="setting-label">ÊØî‰æã</label>
              <el-radio-group v-model="form.parameters.size" size="small" class="compact-radio-group">
                <el-radio-button v-for="size in formSetting.sysAiVincentSupportedSize?.split(',') || []" :key="size" :value="size" class="ratio-button">
                  <div class="ratio-content">
                    <i :style="{ 'aspect-ratio': getRatio(size) }" class="ratio-visual"></i>
                    <span class="ratio-text">{{ size }}</span>
                  </div>
                </el-radio-button>
              </el-radio-group>
            </div>

            <!-- È£éÊ†ºÈÄâÊã© -->
            <div class="setting-item" v-if="form.sysAiModuleType == 'VINCENT' && styleData.length > 0">
              <label class="setting-label">È£éÊ†º</label>
              <el-select v-model="form.parameters.style" placeholder="ÈÄâÊã©È£éÊ†º" size="small" class="compact-select">
                <el-option v-for="item in styleData" :key="item.sysAiVincentStyleCode" :label="item.sysAiVincentStyleName" :value="item.sysAiVincentStyleCode">
                  <div class="style-option">
                    <el-image :src="item.sysAiVincentStyleImage" class="style-icon" />
                    <span>{{ item.sysAiVincentStyleName }}</span>
                  </div>
                </el-option>
              </el-select>
            </div>

            <!-- ËæìÂá∫Êï∞Èáè -->
            <div class="setting-item">
              <label class="setting-label">Êï∞Èáè</label>
              <el-input-number v-model="form.parameters.number" :min="1" :max="formSetting.sysAiVincentSupportedNumber || 4" size="small" class="compact-number" controls-position="right" />
            </div>

            <!-- Ë¥®ÈáèÈÄâÊã©ÔºàËßÜÈ¢ëÊ®°ÂºèÔºâ -->
            <div class="setting-item" v-if="form.sysAiModuleType == 'VIDEO' && formSetting.sysAiVincentSupportedQuality">
              <label class="setting-label">Ë¥®Èáè</label>
              <el-radio-group v-model="form.parameters.quality" size="small" class="compact-radio-group">
                <el-radio-button v-for="item in formSetting.sysAiVincentSupportedQuality?.split(',') || []" :key="item" :value="item">
                  {{ getQuality(item)?.name || item }}
                </el-radio-button>
              </el-radio-group>
            </div>

            <!-- Â∏ßÁéáÈÄâÊã©ÔºàËßÜÈ¢ëÊ®°ÂºèÔºâ -->
            <div class="setting-item" v-if="form.sysAiModuleType == 'VIDEO' && formSetting.sysAiVincentSupportedFps">
              <label class="setting-label">Â∏ßÁéá</label>
              <el-select v-model="form.parameters.fps" placeholder="ÈÄâÊã©Â∏ßÁéá" size="small" class="compact-select">
                <el-option v-for="fps in formSetting.sysAiVincentSupportedFps?.split(',') || []" :key="fps" :label="fps + ' FPS'" :value="fps" />
              </el-select>
            </div>

            <!-- AIÈü≥ÊïàÔºàËßÜÈ¢ëÊ®°ÂºèÔºâ -->
            <div class="setting-item" v-if="form.sysAiModuleType == 'VIDEO' && formSetting.sysAiVincentSupportAudio">
              <label class="setting-label">Èü≥Êïà</label>
              <el-switch v-model="form.parameters.withAudio" :active-value="1" :inactive-value="0" active-text="ÂºÄÂêØ" inactive-text="ÂÖ≥Èó≠" size="small" />
            </div>
          </div>
        </el-scrollbar>
      </div>

      <!-- ‰∏ªËæìÂÖ•Ê°Ü -->
      <div class="input-container">
        <div class="input-wrapper">
          <!-- ‰∏ªËæìÂÖ•Âå∫Âüü -->
          <div class="main-input">
            <EditorSender
              ref="editorSenderRef"
              v-model="currentMessage"
              placeholder="üíå ÊèèËø∞‰Ω†ÊÉ≥Ë¶ÅÁîüÊàêÁöÑÂõæÁâáÊàñËßÜÈ¢ë... ÊîØÊåÅÂ§öÊ®°ÊÄÅËæìÂÖ•"
              :max-length="2000"
              :loading="loadingConfig.export"
              :disabled="loadingConfig.export"
              :auto-focus="true"
              :clearable="true"
              @change="handleCurrentChangeValue"
              variant="updown"
              submit-type="enter"
              :custom-style="{ maxHeight: '200px' }"
              @submit="handleGenerate"
              @clear="handleClearInput"
              class="editor-sender"
            >
              <!-- Ëá™ÂÆö‰πâÂâçÁºÄ -->
              <template #prefix>
                <div class="input-prefix">
                  <el-tooltip content="ÂèÇËÄÉÂõæÁâá" placement="top" v-if="formSetting.sysAiVincentSupportRefImage">
                    <el-button circle @click="handleRefImage">
                      <IconifyIconOnline icon="ri:image-line" />
                    </el-button>
                  </el-tooltip>

                  <el-tooltip content="È´òÁ∫ßËÆæÁΩÆ" placement="top">
                    <el-button circle @click="toggleAdvanced" :type="showAdvanced ? 'primary' : 'default'">
                      <IconifyIconOnline icon="ri:settings-3-line" />
                    </el-button>
                  </el-tooltip>

                  <el-tooltip content="ÈöèÊú∫ÊèèËø∞ËØç" placement="top">
                    <el-button circle @click="handleRandomPrompt" type="default">
                      <IconifyIconOnline icon="ep:refresh" />
                    </el-button>
                  </el-tooltip>
                </div>
              </template>

              <!-- Ëá™ÂÆö‰πâÊìç‰ΩúÂàóË°® -->
              <template #action-list>
                <div class="action-buttons">
                  <!-- Ê®°ÂûãÈÄâÊã©ÊåâÈíÆ -->
                  <ScSelect v-model="form.model" class="min-w-[200px]" :options="modelOptions" layout="dropdown" dropdown-icon="ri:cpu-line" dropdown-title="Ê®°ÂûãÈÄâÊã©" dropdown-placeholder="ÈÄâÊã©Ê®°Âûã" @change="handleModelSelect"> </ScSelect>

                  <!-- ÂàÜËæ®ÁéáÈÄâÊã©ÊåâÈíÆ -->
                  <ScSelect v-model="form.parameters.size" :options="sizeOptions" layout="dropdown" dropdown-icon="ri:aspect-ratio-line" dropdown-title="ÊØî‰æã" dropdown-placeholder="ÈÄâÊã©ÂàÜËæ®Áéá" @change="handleSizeSelect" v-if="sizeOptions && sizeOptions.length > 0" />

                  <!-- È£éÊ†ºÈÄâÊã©ÊåâÈíÆ (‰ªÖVINCENTÁ±ªÂûãÊòæÁ§∫) -->
                  <ScSelect
                    displayMode="large"
                    v-if="form.sysAiModuleType === 'VINCENT' && styleOptions.length > 0"
                    v-model="form.parameters.style"
                    :options="styleOptions"
                    layout="dropdown"
                    dropdown-direction="horizontal"
                    :dropdown-col="4"
                    display-mode="large"
                    width="100%"
                    dropdown-icon="ri:palette-line"
                    dropdown-title="È£éÊ†º"
                    dropdown-placeholder="ÈÄâÊã©È£éÊ†º"
                    @change="handleStyleSelect"
                  >
                    <template #header="{ item }">
                      {{ item }}
                    </template>
                  </ScSelect>

                  <!-- Êï∞ÈáèÈÄâÊã©ÊåâÈíÆ -->
                  <ScSelect v-model="form.parameters.number" :options="numberOptions" layout="dropdown" class="min-w-[150px]" dropdown-icon="ri:hashtag" dropdown-title="Êï∞Èáè" dropdown-placeholder="ÈÄâÊã©Êï∞Èáè" @change="handleNumberSelect" />

                  <!-- ÁîüÊàê/ÂÅúÊ≠¢ÊåâÈíÆ -->
                  <el-button v-if="loadingConfig.export" circle @click="stopGeneration" class="stop-btn">
                    <IconifyIconOnline icon="ri:stop-circle-line" />
                  </el-button>
                  <el-button v-else circle @click="handleGenerate" :disabled="!canGenerate" class="generate-btn" type="primary">
                    <IconifyIconOnline icon="ri:magic-line" />
                  </el-button>
                </div>
              </template>

              <!-- Ëá™ÂÆö‰πâÂ∫ïÈÉ® - ÂèçÂêëÊèêÁ§∫ËØç -->
              <template #footer v-if="form.sysAiModuleType == 'VINCENT' && showAdvanced">
                <div class="negative-prompt-section">
                  <div class="negative-prompt-label">
                    <IconifyIconOnline icon="ri:subtract-line" />
                    <span>ÂèçÂêëÊèêÁ§∫ËØç</span>
                  </div>
                  <el-input v-model="form.input.negativePrompt" type="textarea" :rows="1" placeholder="‰∏çÂ∏åÊúõÂá∫Áé∞ÁöÑÂÜÖÂÆπ..." class="negative-prompt-input"></el-input>
                </div>
              </template>
            </EditorSender>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>
<script setup>
import { IconifyIconOnline } from "@repo/components/ReIcon";
import { useUserStoreHook } from "@repo/core";
import { clearObject, getRandomInt, localStorageProxy, message } from "@repo/utils";

import ScSelect from "@repo/components/ScSelect/index.vue";
import { computed, defineAsyncComponent, onMounted, reactive, ref, shallowRef } from "vue";
import { useRoute } from "vue-router";
import { fetchGetTaskForVincent, fetchSaveTaskForVincent } from "../../../api/ai/text-generations";
import { fetchListForModelStyle } from "../../../api/ai/vincent-style";
import { fetchListForModelTemplate } from "../../../api/ai/vincent-template";
import { fetchListProjectForAiModule } from "../../../api/manage/project-ai-module";
import { RANDOM_DATA } from "./hook";
const HistoryLayout = defineAsyncComponent(() => import("./module/HistoryLayout.vue"));
const ModuleUpdateDialog = defineAsyncComponent(() => import("./module/ModuleUpdateDialog.vue"));
const ModuleDialog = defineAsyncComponent(() => import("./module/ModuleDialog.vue"));
const historyLayoutRef = shallowRef();
const styleData = shallowRef([]);
const loadingConfig = reactive({
  export: false,
});

// Êñ∞ÁöÑÂìçÂ∫îÂºèÂèòÈáè
const showSettings = ref(false);
const showAdvanced = ref(false);
const generatedResults = ref([]);

// EditorSender Áõ∏ÂÖ≥ÂèòÈáè
const currentMessage = ref("");
const editorSenderRef = ref(null);

// ÂàùÂßãÂåñcurrentMessageÁöÑÂÄº
currentMessage.value = "‰∏ÄÂè™ÂùêÁùÄÁöÑÊ©òÈªÑËâ≤ÁöÑÁå´ÔºåË°®ÊÉÖÊÑâÊÇ¶ÔºåÊ¥ªÊ≥ºÂèØÁà±ÔºåÈÄºÁúüÂáÜÁ°Æ„ÄÇ";

// ÁõëÂê¨form.input.promptÁöÑÂèòÂåñÔºåÂêåÊ≠•Âà∞currentMessage
// watch(
//   () => form.input.prompt,
//   (newVal) => {
//     if (newVal !== currentMessage.value) {
//       currentMessage.value = newVal;
//     }
//   },
//   { immediate: true }
// );

const props = defineProps({
  category: "IMAGE",
  type: "VINCENT",
  selectedItemLabel: "ai-image-generations-selected",
});
const form = reactive({
  tokens: 2048,
  topK: 4,
  temperature: 0.5,
  sysProjectId: null,
  sysAiModuleType: "VINCENT",
  input: {
    prompt: "‰∏ÄÂè™ÂùêÁùÄÁöÑÊ©òÈªÑËâ≤ÁöÑÁå´ÔºåË°®ÊÉÖÊÑâÊÇ¶ÔºåÊ¥ªÊ≥ºÂèØÁà±ÔºåÈÄºÁúüÂáÜÁ°Æ„ÄÇ",
    negativePrompt: null,
    refImg: null,
  },
  parameters: {
    style: "<auto>",
    size: "1024*1024",
    seed: null,
    number: 1,
    refStrength: null,
  },
});
const formSetting = reactive({});
const randomPrompt = shallowRef("");
const moduleUpdateDialogRef = shallowRef();
const moduleDialogRef = shallowRef();
const formRef = shallowRef();
const modelList = shallowRef([]);
const templateList = ref([]);
const env = {
  category: "IMAGE",
};
const rules = {
  model: [{ required: true, message: "ËØ∑ÈÄâÊã©Ê®°Âûã", trigger: "change" }],
  tokens: [{ required: true, message: "ËØ∑ËæìÂÖ•tokens", trigger: "change" }],
  topK: [{ required: true, message: "ËØ∑ËæìÂÖ•topK", trigger: "change" }],
  temperature: [{ required: true, message: "ËØ∑ËæìÂÖ•temperature", trigger: "change" }],
  "parameters.size": [{ required: true, message: "ËØ∑ËæìÂÖ•ÊØî‰æã", trigger: "change" }],
  "parameters.style": [{ required: true, message: "ËØ∑ËæìÂÖ•È£éÊ†º", trigger: "change" }],
  "parameters.number": [{ required: true, message: "ËØ∑ËæìÂÖ•ËæìÂá∫ÂõæÁâáÂº†Êï∞", trigger: "change" }],
};
const route = useRoute();

// Êñ∞ÁöÑÂàáÊç¢ÊñπÊ≥ï
const toggleSettings = () => {
  showSettings.value = !showSettings.value;
};

const toggleAdvanced = () => {
  showAdvanced.value = !showAdvanced.value;
};

const handleRefImage = () => {
  // Â§ÑÁêÜÂèÇËÄÉÂõæÁâáÈÄâÊã©
  console.log("ÈÄâÊã©ÂèÇËÄÉÂõæÁâá");
};

const handleRandomPrompt = async () => {
  // Ëé∑ÂèñÈöèÊú∫ÊèèËø∞ËØç
  await handleRefreshRandom();
  // Â∞ÜÈöèÊú∫ÊèèËø∞ËØçËÆæÁΩÆÂà∞ËæìÂÖ•Ê°Ü
  currentMessage.value = randomPrompt.value;
  form.input.prompt = randomPrompt.value;
  // Â¶ÇÊûúEditorSenderÁªÑ‰ª∂ÊúâsetValueÊñπÊ≥ïÔºå‰πüÂêåÊ≠•ËÆæÁΩÆ
  if (editorSenderRef.value && editorSenderRef.value.setValue) {
    editorSenderRef.value.setValue(randomPrompt.value);
  }
};

const handleGenerate = async () => {
  // ÂêåÊ≠•EditorSenderÁöÑÂÜÖÂÆπÂà∞form.input.prompt
  if (currentMessage.value.trim()) {
    form.input.prompt = currentMessage.value.trim();
  }
  // Â§ÑÁêÜÁîüÊàêËØ∑Ê±Ç
  await handleExport();
};

// EditorSender Áõ∏ÂÖ≥ÊñπÊ≥ï
const handleCurrentChangeValue = async () => {
  if (editorSenderRef.value) {
    const result = editorSenderRef.value.getCurrentValue();
    currentMessage.value = result.text;
    form.input.prompt = result.text;
  }
};

const handleClearInput = () => {
  currentMessage.value = "";
  form.input.prompt = "";
  if (editorSenderRef.value) {
    editorSenderRef.value.clear();
  }
};

// ‰∏ãÊãâÈÄâÊã©Â§ÑÁêÜÊñπÊ≥ï
const handleModelSelect = (modelValue) => {
  form.model = modelValue;
  handleChangeModule(modelValue);
};

const handleSizeSelect = (sizeValue) => {
  form.parameters.size = sizeValue;
};

const handleStyleSelect = (styleValue) => {
  form.parameters.style = styleValue;
};

const handleNumberSelect = (numberValue) => {
  form.parameters.number = numberValue;
};

// ÈÄâÈ°πÊï∞ÊçÆ
const sizeOptions = computed(() => {
  const sizes = formSetting.sysAiVincentSupportedSize?.split(",") || [];
  return sizes.map((size) => ({
    value: size,
    label: size,
    description: getRatio(size),
  }));
});

const styleOptions = computed(() => {
  return styleData.value.map((style) => ({
    value: style.sysAiVincentStyleCode,
    label: style.sysAiVincentStyleName,
    preview: style.sysAiVincentStyleImage,
  }));
});

const numberOptions = computed(() => {
  const maxNumber = formSetting.sysAiVincentSupportedNumber || 4;
  const options = [];
  for (let i = 1; i <= maxNumber; i++) {
    options.push({
      value: i,
      label: `${i}Âº†`,
      description: i === 1 ? "ÂçïÂº†ÁîüÊàê" : `ÁîüÊàê${i}Âº†ÂõæÁâá`,
    });
  }
  return options;
});

const modelOptions = computed(() => {
  return modelList.value.map((model) => ({
    value: model.sysAiModuleCode,
    label: model.sysAiModuleName,
    description: model.sysAiModuleRemark || model.sysAiModuleName,
    icon: model.sysProjectIcon,
  }));
});

const stopGeneration = () => {
  // ÂÅúÊ≠¢ÁîüÊàê
  loadingConfig.export = false;
  console.log("ÂÅúÊ≠¢ÁîüÊàê");
};

// ËÆ°ÁÆóÂ±ûÊÄßÔºöÊòØÂê¶ÂèØ‰ª•ÁîüÊàê
const canGenerate = computed(() => {
  return currentMessage.value.trim().length > 0 && !loadingConfig.export;
});

const previewMedia = (result) => {
  // È¢ÑËßàÂ™í‰ΩìÊñá‰ª∂
  console.log("È¢ÑËßàÂ™í‰Ωì:", result);
};

// ÂéÜÂè≤ËÆ∞ÂΩïÁõ∏ÂÖ≥ÊñπÊ≥ïÂ∑≤ÁßªÈô§ÔºåÁé∞Âú®HistoryLayoutÂßãÁªàÊòæÁ§∫

const modelSelectStyle = computed(() => {
  return styleData.value.find((it) => it.sysAiVincentStyleCode === form.parameters.style)?.sysAiVincentStyleImage;
});

// ÂΩìÂâçÈÄâÊã©ÁöÑÊ®°ÂûãÂêçÁß∞
const currentModelName = computed(() => {
  const model = modelList.value.find((it) => it.sysAiModuleCode === form.model);
  return model?.sysAiModuleName || "ÈÄâÊã©Ê®°Âûã";
});

// ÂΩìÂâçÈÄâÊã©ÁöÑÂàÜËæ®Áéá
const currentSizeName = computed(() => {
  return form.parameters.size || "ÈÄâÊã©ÂàÜËæ®Áéá";
});

// ÂΩìÂâçÈÄâÊã©ÁöÑÈ£éÊ†ºÂêçÁß∞
const currentStyleName = computed(() => {
  const style = styleData.value.find((it) => it.sysAiVincentStyleCode === form.parameters.style);
  return style?.sysAiVincentStyleName || "ÈÄâÊã©È£éÊ†º";
});
/**
 * Ëé∑ÂèñÈöèÊú∫ÊèêÁ§∫ËØç
 */
const handleRefreshRandom = async () => {
  randomPrompt.value = RANDOM_DATA[getRandomInt(0, RANDOM_DATA.length - 1)];
};
const showRoleSetting = computed(() => {
  const item = modelList.value.filter((it) => (it.sysAiModuleCode = form.model));
  return item ? item?.[0]?.sysAiModuleRoleSetting : 0;
});

let intervalId = null;
/**
 * Ëé∑ÂèñÊØî‰æã
 */
const getRatio = (item) => {
  let _width = 1024;
  let _height = 1024;
  if (item.indexOf("*") > -1) {
    const _it = item.split("*");
    _width = ~~_it[0]?.trim();
    _height = ~~_it[1]?.trim();
  } else {
    const _it = item.split("x");
    _width = ~~_it[0]?.trim();
    _height = ~~_it[1]?.trim();
  }
  function gcd(a, b) {
    // ËæóËΩ¨Áõ∏Èô§Ê≥ïËÆ°ÁÆóÊúÄÂ§ßÂÖ¨Á∫¶Êï∞
    while (b !== 0) {
      const temp = b;
      b = a % b;
      a = temp;
    }
    return a;
  }
  // ËÆ°ÁÆóÊúÄÂ§ßÂÖ¨Á∫¶Êï∞
  const commonDivisor = gcd(_width, _height);

  // ÁÆÄÂåñÂÆΩÈ´òÊØî
  const simplifiedWidth = _width / commonDivisor;
  const simplifiedHeight = _height / commonDivisor;

  return `${simplifiedWidth}/${simplifiedHeight}`;
};

/**
 * Ëé∑ÂèñË¥®ÈáèÈÖçÁΩÆ
 */
const getQuality = (quality) => {
  const qualityMap = {
    HD: { name: "È´òÊ∏Ö", value: "HD" },
    FHD: { name: "ÂÖ®È´òÊ∏Ö", value: "FHD" },
    "4K": { name: "Ë∂ÖÈ´òÊ∏Ö", value: "4K" },
    low: { name: "Ê†áÊ∏Ö", value: "low" },
    medium: { name: "‰∏≠Á≠â", value: "medium" },
    high: { name: "È´òË¥®Èáè", value: "high" },
  };
  return qualityMap[quality] || { name: quality, value: quality };
};

/**
 * Ëé∑Âèñkey
 */
const requestId = () => {
  const _requestId = localStorageProxy().getItem("vincent-request-id:" + getKey());
  return _requestId;
};

const handleReDraw = async (value, type) => {
  if ("model" == type) {
    form.model = value;
    handleChangeModule(value);
    return;
  }
  form.input.prompt = value;
};
const loadedRequestId = async (row) => {
  localStorageProxy().setItem("vincent-request-id:" + getKey(), row.data?.output?.taskId);
};
const loadInterval = () => {
  if (intervalId) {
    clearInterval(intervalId);
    intervalId = null;
  }

  if (requestId()) {
    createInterval();
  }
};

const process = reactive({});
const initialImageIndex = async () => {
  for (let index = 0; index < form.parameters.number; index++) {
    process[index] = 10;
  }
};
const updateImageIndex = async (finished, progress) => {
  // ÂõæÁâáÁ¥¢ÂºïÊõ¥Êñ∞ÈÄªËæëÂ∑≤ÁßªËá≥Êñ∞ÁöÑÂ±ïÁ§∫Âå∫Âüü
};

const getKey = () => {
  return form.model.replace("/", "_");
};
const clearTask = () => {
  clearInterval(intervalId);
  intervalId = null;
  localStorageProxy().removeItem("vincent-request-id:" + getKey());
  updateImageIndex(true);
  loadingConfig.export = false;
};

const updateImage = async (images) => {
  // Êõ¥Êñ∞ÁîüÊàêÁªìÊûúÂà∞Êñ∞ÁöÑÂ±ïÁ§∫Âå∫Âüü
  if (images && images.length > 0) {
    const newResults = images.map((url, index) => ({
      id: Date.now() + index,
      type: form.sysAiModuleType === "VIDEO" ? "video" : "image",
      url: url,
      timestamp: new Date().toISOString(),
    }));
    generatedResults.value = newResults;
  } else {
    generatedResults.value = [];
  }

  // ÂõæÁâáÊõ¥Êñ∞Â∑≤ÁßªËá≥Êñ∞ÁöÑÂ±ïÁ§∫Âå∫Âüü
};
const createInterval = () => {
  if (!requestId()) {
    loadingConfig.export = false;
    clearTask();
    updateImage([]);
    return;
  }
  intervalId = setInterval(() => {
    fetchGetTaskForVincent({ taskId: requestId(), sysProjectId: form.sysProjectId, sysAiModuleType: form.sysAiModuleType, model: form.model })
      .then((res) => {
        if (res.data?.output?.taskStatus === "SUCCESS") {
          clearTask();
          updateImage(res.data?.output?.results?.map((it) => it.url));
          updateImageIndex(true, 100);
        } else {
          updateImageIndex(false, res.data.progress);
        }
      })
      .catch((e) => {
        loadingConfig.export = false;
        clearTask();
        updateImage([]);
      });
  }, 5000);
};
const handleExport = async () => {
  // Â¶ÇÊûúÊ≤°ÊúâformRefÔºåÁõ¥Êé•ÊâßË°åÁîüÊàêÈÄªËæë
  const executeGeneration = async () => {
    loadingConfig.export = true;
    initialImageIndex();
    if (historyLayoutRef.value) {
      historyLayoutRef.value.updateData();
    }

    try {
      const res = await fetchSaveTaskForVincent(form);

      if (res.data?.output?.taskStatus === "FAILURE") {
        loadingConfig.export = false;
        clearTask();
        updateImage([]);
        message("ÂàõÂª∫‰ªªÂä°Â§±Ë¥•!", { type: "error" });
        return;
      }

      if (res.data?.output?.images) {
        clearTask();
        updateImage(res.data.output.images);
        updateImageIndex(true, 100);
        return;
      }

      loadedRequestId(res);
      createInterval();
    } catch (e) {
      loadingConfig.export = false;
      clearTask();
      updateImage([]);
      message("ÁîüÊàêÂ§±Ë¥•!", { type: "error" });
    }
  };

  if (formRef.value) {
    formRef.value.validate(async (valid) => {
      if (valid) {
        await executeGeneration();
      }
    });
  } else {
    // ÁÆÄÂçïÈ™åËØÅÂøÖË¶ÅÂ≠óÊÆµ
    if (!form.model) {
      message("ËØ∑ÈÄâÊã©Ê®°Âûã", { type: "warning" });
      return;
    }
    if (!form.input.prompt) {
      message("ËØ∑ËæìÂÖ•ÊèêÁ§∫ËØç", { type: "warning" });
      return;
    }
    await executeGeneration();
  }
};
const handleChangeModule = async (value) => {
  const _item = modelList.value.find((it) => it.sysAiModuleCode === value);
  env.sysProjectId = _item.sysProjectId;
  env.sysProjectName = _item.sysProjectName;
  env.sysAiModuleId = _item.sysAiModuleId;
  form.sysProjectId = _item.sysProjectId;
  form.sysAiModuleId = _item.sysAiModuleId;
  form.sysProjectName = _item.sysProjectName;
  form.model = value;
  loadConfig(_item, value);
};

const modelSelectLabel = computed(() => {
  return modelList.value.find((it) => it.sysAiModuleCode === form.model);
});

const onAfterProperieSet = () => {
  handleRefreshRandom();
  const query = route.query;
  env.sysProjectId = query.sysProjectId;
  env.category = query.category || props.category || "IMAGE";
  env.showEdit = !useUserStoreHook().tenantId;
  env.sysProjectName = query.sysProjectName;
  form.sysAiModuleType = query.type || props.type || "VINCENT";
  form.sysProjectId = env.sysProjectId;
  form.sysProjectName = env.sysProjectName;
  if (requestId) {
    loadConfig.export = true;
  }
};

const handleOpenModule = async () => {
  moduleUpdateDialogRef.value.handleOpen(form, "add");
};
const handleOpenModuleManager = async () => {
  moduleDialogRef.value.handleOpen(form, "add");
};
const handleRefreshEnvironment = async () => {
  await initialModuleList();
};

const handleRefreshEnvironmentTemplate = async () => {
  loadTemplate();
};

/**
 * Âä†ËΩΩÊ®°Êùø
 */
const loadTemplate = async () => {
  const { data } = await fetchListForModelTemplate({
    sysAiModuleId: form.sysAiModuleId,
  });
  templateList.value = data;
};
const loadModule = async () => {
  handleRefreshEnvironment();
};
const initialModuleList = async () => {
  const { data } = await fetchListProjectForAiModule(form);
  modelList.value = data;
  const _selectedModel = localStorageProxy().getItem(props.selectedItemLabel);
  if (_selectedModel) {
    handleChangeModule(_selectedModel);
    loadInterval();
    return;
  }
  if (modelList.value.length == 1) {
    form.model = modelList.value[0].sysAiModuleCode;
    form.sysAiModuleId = modelList.value[0].sysAiModuleId;
    form.sysProjectId = modelList.value[0].sysProjectId;
    loadConfig(modelList.value[0]);
    loadInterval();
  }
};

const loadConfig = async (row, sysAiModuleCode) => {
  clearObject(formSetting);
  Object.assign(formSetting, row?.vincentSetting);
  localStorageProxy().setItem(props.selectedItemLabel, sysAiModuleCode);
  loadTemplate();
  loadStyle(row);
};
const loadStyle = async (row) => {
  loadingConfig.loading = true;
  try {
    const { data } = await fetchListForModelStyle({
      sysAiModuleId: form.sysAiModuleId,
    });
    styleData.value = data;
    form.parameters.style = styleData.value.length > 0 ? styleData.value[0]?.sysAiVincentStyleCode : "";
  } catch (error) {}
  loadingConfig.loading = false;
};
onMounted(async () => {
  onAfterProperieSet();
  initialModuleList();
});
</script>
<style scoped lang="scss">
:deep(.el-main) {
  padding: 0;
}
:deep(.video-js .vjs-big-play-button) {
  top: calc(50% - 24px);
  left: calc(50% - 48px);
}

.common-layout {
  height: 100%;
}

/* Áé∞‰ª£ÂåñÂÆπÂô®Ê†∑Âºè */
.modern-container {
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.05);
  transition: all 0.3s ease;
  height: calc(100vh - 20px);
}

/* ‰∏ªÂÜÖÂÆπÂå∫Ê†∑Âºè */
.modern-main {
  background-color: var(--el-bg-color-2);
  border-radius: 16px;
  transition: all 0.3s ease;
}

/* ÂÜÖÂÆπÂç°ÁâáÊ†∑Âºè */
.modern-content {
  border-radius: 16px;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
  transition: all 0.3s ease;
  overflow: hidden;
}

/* ÊµÆÂä®ËÆæÁΩÆÊåâÈíÆ */
.floating-settings-btn {
  position: fixed;
  right: 20px;
  top: 50%;
  transform: translateY(-50%);
  z-index: 99;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);

  &:hover {
    transform: translateY(-50%) scale(1.1) rotate(15deg);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
  }
}

/* ÂéÜÂè≤ËÆ∞ÂΩïÂàáÊç¢ÊåâÈíÆ */
.history-toggle {
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  padding: 8px 16px;
  border-radius: 20px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  cursor: pointer;
  z-index: 10;
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);

  &:hover {
    transform: translateX(-50%) translateY(-3px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  &-visible {
    top: 250px;
  }

  &-hidden {
    top: 0;
  }
}

/* Êñ∞ÁöÑAIÁîüÊàêÂô®Â∏ÉÂ±ÄÊ†∑Âºè */
.ai-generator-layout {
  height: 100vh;
  display: flex;
  flex-direction: column;
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  overflow: hidden;
}

/* ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü */
.main-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  padding-bottom: 0;
}

/* Â™í‰ΩìÂ±ïÁ§∫Âå∫ÂüüÊ†∑ÂºèÂ∑≤ÁßªËá≥ HistoryLayout Âíå MediaDisplay ÁªÑ‰ª∂ */

/* ÂéÜÂè≤ËÆ∞ÂΩïÂå∫Âüü */
.history-section {
  background: white;
  border-radius: 16px;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
  margin-bottom: 20px;
  overflow: hidden;
}

/* Â∫ïÈÉ®ËæìÂÖ•Âå∫Âüü */
.bottom-input-area {
  background: white;
  border-radius: 16px 16px 0 0;
  box-shadow: 0 -4px 32px rgba(0, 0, 0, 0.1);
  padding: 20px;
}

/* ËÆæÁΩÆÈÄâÈ°πÊ†è */
.settings-bar {
  margin-bottom: 16px;
  max-height: 120px;
  background: #f8f9fa;
  border-radius: 12px;
  padding: 16px;
}

.settings-scroll {
  height: 100%;
}

.settings-content {
  display: flex;
  gap: 20px;
  align-items: center;
  flex-direction: row;
}

.setting-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 8px 0;
  flex-wrap: wrap;
  min-width: 120px;
}

.setting-label {
  font-size: 12px;
  color: #8b949e;
  min-width: 40px;
  white-space: nowrap;
  font-weight: 500;
}

.compact-select {
  min-width: 120px;
}

.compact-radio-group {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
}

.ratio-button {
  margin: 0 !important;
}

.ratio-content {
  display: flex;
  align-items: center;
  gap: 4px;
}

.ratio-visual {
  width: 12px;
  height: 12px;
  background: rgba(64, 158, 255, 0.3);
  border: 1px solid #409eff;
  border-radius: 2px;
  display: inline-block;
}

.ratio-text {
  font-size: 11px;
}

.compact-number {
  width: 80px;
}

.model-option,
.style-option {
  display: flex;
  align-items: center;
  gap: 8px;
}

.model-icon,
.style-icon {
  width: 20px;
  height: 20px;
  border-radius: 4px;
}

/* ËæìÂÖ•ÂÆπÂô® */
.input-container {
  background: #f8f9fa;
  border-radius: 12px;
  padding: 16px;
}

.input-wrapper {
  display: flex;
  align-items: flex-end;
  gap: 12px;
}

.input-tools {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.main-input {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.prompt-input,
.negative-prompt-input {
  border-radius: 8px;
  transition: all 0.3s ease;
}

.prompt-input :deep(.el-textarea__inner) {
  border-radius: 8px;
  border: 2px solid #e4e7ed;
  transition: all 0.3s ease;
}

.prompt-input :deep(.el-textarea__inner:focus) {
  border-color: var(--el-color-primary);
  box-shadow: 0 0 0 2px var(--el-color-primary-light-8);
}

.negative-prompt-input :deep(.el-textarea__inner) {
  border-radius: 8px;
  border: 1px solid #e4e7ed;
  background-color: #fafafa;
}

.input-actions {
  display: flex;
  align-items: flex-end;
  gap: 8px;
}

/* ÂìçÂ∫îÂºèËÆæËÆ° */
@media (max-width: 768px) {
  .main-content {
    padding: 10px;
  }

  .settings-content {
    flex-direction: column;
    align-items: stretch;
  }

  .setting-item {
    min-width: auto;
    justify-content: space-between;
  }

  .input-wrapper {
    flex-direction: column;
    align-items: stretch;
  }

  .input-tools,
  .input-actions {
    flex-direction: row;
    justify-content: center;
  }

  .media-grid {
    grid-template-columns: 1fr;
  }
}

/* Âä®ÁîªÊïàÊûú */
.fade-slide-enter-active,
.fade-slide-leave-active {
  transition: all 0.3s ease;
}

.fade-slide-enter-from {
  opacity: 0;
  transform: translateY(20px);
}

.fade-slide-leave-to {
  opacity: 0;
  transform: translateY(-20px);
}

/* ÂèÇËÄÉÂõæÂÉèÊ†∑Âºè */
.ref-image {
  left: var(--aside-width);
  z-index: 2;
  height: 100%;
  background-color: var(--el-bg-color);
  box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.1);
  border-radius: 16px;
  transition: all 0.3s ease;
}

.ref-image-item {
  transition: all 0.3s ease;
  margin-bottom: 16px;

  &:hover {
    transform: translateY(-5px);
  }

  .img {
    border-radius: 12px;
    padding-top: 4px;
    box-shadow:
      0px 2px 4px 0px rgba(0, 0, 0, 0.1),
      0px 7px 13px -3px rgba(0, 0, 0, 0.1),
      0px -3px 0px 0px rgba(0, 0, 0, 0.05) inset;
    transition: all 0.3s ease;

    &:hover {
      transform: scale(1.02);
    }
  }

  .text {
    margin-top: 8px;
    font-weight: 500;
    text-shadow:
      1px 1px 0px #d7e8f9,
      2px 2px 0px #d7e8f9;
    transition: all 0.3s ease;
  }
}

/* ‰øùÁïôÂéüÊúâÊ†∑Âºè */
.text-template {
  color: #8f91a8;
}

.layout-main {
  background-color: var(--el-bg-color-2);
}

.active {
  background: #eeedff;
}

:deep(.item .el-radio-button__inner) {
  border-radius: 20px;
  border: 1px solid var(--border-color);
}

.ration--GrtZmC3d .list--mF4x7otZ .item--jRS5LJnK {
  align-items: center;
  background: var(--wanx-v2-color4);
  border-radius: 100px;
  cursor: pointer;
  display: flex;
  padding: 11px 0;
  width: calc(33.33333% - 5.33333px);
}

#chat {
  height: calc(100vh - 150px);
}

.item-parent-item {
  align-items: center;
  display: flex;
  height: 20px;
  margin-top: 8px;
  color: #8f91a8;
}

.el-form-item-msg1 {
  width: 200px;
  display: inline-block;
  cursor: pointer;
  flex: 1;
  font-size: 12px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.size-center {
  align-content: center;
}

.ai-generator_apsect_ratio_vis2__IHeeP {
  display: block;
  width: 12px;
  background: rgba(114, 46, 209, 0.7);
  border: 1px solid #3c3f44;
  border-radius: 1px;
  transition: 0.2s ease-in-out;
}

/* ‰∏ä‰º†ÁªÑ‰ª∂Ê†∑Âºè */
:deep(.avatar-uploader .el-upload) {
  border: 1px dashed var(--el-border-color);
  border-radius: 12px;
  cursor: pointer;
  position: relative;
  overflow: hidden;
  transition: var(--el-transition-duration-fast);

  &:hover {
    border-color: var(--el-color-primary);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
  }
}

:deep(.el-upload-list) {
  margin: 0;
}

.avatar-uploader {
  display: flex;
  flex-direction: row;
  height: 180px;
  margin-top: 10px;
}

.avatar-uploader .avatar {
  width: 178px;
  height: 178px;
  display: block;
}

.el-icon.avatar-uploader-icon {
  font-size: 28px;
  color: #8c939d;
  width: 178px;
  height: 178px;
  text-align: center;
}

.el-upload-list__item-actions {
  display: flex;
  position: absolute;
  top: 10px;
  right: 10px;
}

/* ÊåâÈíÆÂä®Áîª */
:deep(.el-button) {
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);

  &:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  &:active {
    transform: translateY(0);
  }
}

/* ÈÄâÊã©Âô®Âä®Áîª */
:deep(.el-select-dropdown__item) {
  transition: all 0.2s ease;

  &.selected {
    background-color: rgba(var(--el-color-primary-rgb), 0.1);
  }

  &:hover {
    background-color: rgba(var(--el-color-primary-rgb), 0.05);
    transform: translateX(5px);
  }
}

/* Êìç‰ΩúÊåâÈíÆÊ†∑Âºè */
.action-buttons {
  display: flex;
  align-items: center;
  gap: 8px;
}

.action-btn {
  background: var(--el-bg-color-overlay);
  border: 1px solid var(--el-border-color-light);
  color: var(--el-text-color-regular);
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 12px;
  min-width: auto;
  white-space: nowrap;
}

.action-btn:hover {
  background: var(--el-bg-color);
  color: var(--el-text-color-primary);
  transform: translateY(-1px);
  box-shadow: 0 2px 8px var(--el-box-shadow-light);
}

.action-btn .btn-text {
  font-size: 12px;
  max-width: 80px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.generate-btn {
  background: var(--el-color-primary);
  border: none;
  color: var(--el-color-white);
  transition: all 0.3s ease;
}

.generate-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px var(--el-box-shadow);
  background: var(--el-color-primary-light-3);
}

.stop-btn {
  background: var(--el-color-danger);
  border: none;
  color: var(--el-color-white);
  transition: all 0.3s ease;
}

.stop-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px var(--el-box-shadow);
  background: var(--el-color-danger-light-3);
}

/* ‰∏ãÊãâËèúÂçïÊ†∑Âºè */
:deep(.model-dropdown),
:deep(.size-dropdown),
:deep(.style-dropdown) {
  .el-dropdown-menu {
    border-radius: var(--el-border-radius-base);
    box-shadow: var(--el-box-shadow-dark);
    border: 1px solid var(--el-border-color-lighter);
    backdrop-filter: blur(20px);
    background: var(--el-bg-color-overlay);
  }

  .el-dropdown-menu__item {
    padding: 12px 16px;
    border-radius: var(--el-border-radius-small);
    margin: 4px 8px;
    transition: all 0.2s ease;

    &:hover {
      background: var(--el-color-primary-light-9);
      color: var(--el-color-primary);
    }

    &.is-active {
      background: var(--el-color-primary);
      color: var(--el-color-white);
    }
  }
}

.model-item,
.size-item {
  .model-name,
  .size-name {
    font-weight: 500;
    font-size: var(--el-font-size-base);
    margin-bottom: 2px;
    color: var(--el-text-color-primary);
  }

  .model-desc,
  .size-desc {
    font-size: var(--el-font-size-small);
    color: var(--el-text-color-regular);
  }
}

.style-item {
  display: flex;
  align-items: center;
  gap: 12px;

  .style-name {
    font-weight: 500;
    font-size: var(--el-font-size-base);
    flex: 1;
    color: var(--el-text-color-primary);
  }

  .style-preview {
    width: 32px;
    height: 32px;
    border-radius: var(--el-border-radius-small);
    background-size: cover;
    background-position: center;
    border: 2px solid var(--el-border-color-light);
    box-shadow: var(--el-box-shadow-light);
  }
}

/* ÂèçÂêëÊèêÁ§∫ËØçÂå∫ÂüüÊ†∑Âºè */
.negative-prompt-section {
  margin-top: 12px;
  padding: 12px;
  background: var(--el-color-danger-light-9);
  border-radius: var(--el-border-radius-base);
  border: 1px solid var(--el-color-danger-light-8);
}

.negative-prompt-label {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 8px;
  font-size: var(--el-font-size-small);
  color: var(--el-color-danger);
  font-weight: 500;
}

.input-prefix {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 0 8px;
}
</style>
