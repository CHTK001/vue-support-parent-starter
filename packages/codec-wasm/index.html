<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SM2算法结果对比测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .input-section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        .input-group {
            margin-bottom: 10px;
        }
        label {
            display: inline-block;
            width: 120px;
            font-weight: bold;
        }
        input[type="text"] {
            width: 300px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            display: block;
            margin: 20px auto;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .result-section {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .result-column {
            flex: 1;
            padding: 15px;
            border-radius: 5px;
        }
        .js-result {
            background-color: #e8f4fd;
            border: 1px solid #b8daff;
        }
        .wasm-result {
            background-color: #e8fff0;
            border: 1px solid #b8ffc4;
        }
        .result-title {
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ddd;
        }
        .result-item {
            margin-bottom: 8px;
        }
        .result-label {
            font-weight: bold;
            display: inline-block;
            width: 100px;
        }
        .result-value {
            font-family: monospace;
            word-break: break-all;
        }
        .log {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>SM2算法结果对比测试</h1>
        
        <div class="input-section">
            <div class="input-group">
                <label for="testData">测试数据:</label>
                <input type="text" id="testData" value="Hello, World!">
            </div>
            <div class="input-group">
                <label for="testKey">测试密钥:</label>
                <input type="text" id="testKey" value="1234567890abcdef">
            </div>
        </div>
        
        <button id="runTest">运行SM2对比测试</button>
        
        <div id="logs"></div>
        
        <div class="result-section">
            <div class="result-column js-result">
                <div class="result-title">JavaScript版本结果</div>
                <div class="result-item">
                    <span class="result-label">输入数据:</span>
                    <span class="result-value" id="jsInputData"></span>
                </div>
                <div class="result-item">
                    <span class="result-label">输入密钥:</span>
                    <span class="result-value" id="jsInputKey"></span>
                </div>
                <div class="result-item">
                    <span class="result-label">加密结果:</span>
                    <span class="result-value" id="jsEncrypted"></span>
                </div>
                <div class="result-item">
                    <span class="result-label">解密结果:</span>
                    <span class="result-value" id="jsDecrypted"></span>
                </div>
            </div>
            
            <div class="result-column wasm-result">
                <div class="result-title">WASM版本结果</div>
                <div class="result-item">
                    <span class="result-label">输入数据:</span>
                    <span class="result-value" id="wasmInputData"></span>
                </div>
                <div class="result-item">
                    <span class="result-label">输入密钥:</span>
                    <span class="result-value" id="wasmInputKey"></span>
                </div>
                <div class="result-item">
                    <span class="result-label">加密结果:</span>
                    <span class="result-value" id="wasmEncrypted"></span>
                </div>
                <div class="result-item">
                    <span class="result-label">解密结果:</span>
                    <span class="result-value" id="wasmDecrypted"></span>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeWasmModule, smCrypto } from './src/index.js';

        const runTestButton = document.getElementById('runTest');
        const logsContainer = document.getElementById('logs');
        
        // 输入元素
        const testDataInput = document.getElementById('testData');
        const testKeyInput = document.getElementById('testKey');
        
        // JavaScript结果元素
        const jsInputData = document.getElementById('jsInputData');
        const jsInputKey = document.getElementById('jsInputKey');
        const jsEncrypted = document.getElementById('jsEncrypted');
        const jsDecrypted = document.getElementById('jsDecrypted');
        
        // WASM结果元素
        const wasmInputData = document.getElementById('wasmInputData');
        const wasmInputKey = document.getElementById('wasmInputKey');
        const wasmEncrypted = document.getElementById('wasmEncrypted');
        const wasmDecrypted = document.getElementById('wasmDecrypted');

        // 重写console.log以便在页面上显示日志
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            
            const logElement = document.createElement('div');
            logElement.className = 'log';
            logElement.textContent = args.join(' ');
            logsContainer.appendChild(logElement);
            
            // 滚动到底部
            logsContainer.scrollTop = logsContainer.scrollHeight;
        };

        // 重写console.error以便在页面上显示错误
        const originalError = console.error;
        console.error = function(...args) {
            originalError.apply(console, args);
            
            const logElement = document.createElement('div');
            logElement.className = 'log';
            logElement.textContent = 'ERROR: ' + args.join(' ');
            logElement.style.color = 'red';
            logsContainer.appendChild(logElement);
            
            // 滚动到底部
            logsContainer.scrollTop = logsContainer.scrollHeight;
        };

        // SM2对比测试函数
        async function runSM2Comparison() {
            runTestButton.disabled = true;
            logsContainer.innerHTML = '';
            
            // 清空之前的结果
            jsInputData.textContent = '';
            jsInputKey.textContent = '';
            jsEncrypted.textContent = '';
            jsDecrypted.textContent = '';
            
            wasmInputData.textContent = '';
            wasmInputKey.textContent = '';
            wasmEncrypted.textContent = '';
            wasmDecrypted.textContent = '';
            
            try {
                console.log('正在初始化WASM模块...');
                await initializeWasmModule();
                console.log('WASM模块初始化完成');
                
                // 获取输入值
                const testData = testDataInput.value || "Hello, World!";
                const testKey = testKeyInput.value || "1234567890abcdef";
                
                console.log('开始运行SM2对比测试...');
                console.log('测试数据:', testData);
                console.log('测试密钥:', testKey);
                
                // 显示输入值
                jsInputData.textContent = testData;
                jsInputKey.textContent = testKey;
                
                wasmInputData.textContent = testData;
                wasmInputKey.textContent = testKey;
                
                // JavaScript版本测试
                try {
                    console.log('正在使用JavaScript版本进行SM2加密...');
                    // 注意：sm-crypto库需要在浏览器环境中正确导入
                    if (smCrypto && smCrypto.sm2) {
                        const jsEncryptedResult = smCrypto.sm2.doEncrypt(testData, testKey, 1); // 1表示C1C3C2格式
                        console.log('JavaScript sm-crypto库加密结果:', jsEncryptedResult);
                        jsEncrypted.textContent = jsEncryptedResult;
                        
                        const jsDecryptedResult = smCrypto.sm2.doDecrypt(jsEncryptedResult, testKey, 1); // 1表示C1C3C2格式
                        console.log('JavaScript sm-crypto库解密结果:', jsDecryptedResult);
                        jsDecrypted.textContent = jsDecryptedResult;
                    } else {
                        console.error('sm-crypto库未正确加载');
                        jsEncrypted.textContent = '错误：sm-crypto库未正确加载';
                        jsDecrypted.textContent = '错误：sm-crypto库未正确加载';
                    }
                } catch (error) {
                    console.error('JavaScript sm-crypto库处理出错:', error);
                    jsEncrypted.textContent = '错误：' + error.message;
                    jsDecrypted.textContent = '错误：' + error.message;
                }
                
                // WASM版本测试
                try {
                    console.log('正在使用WASM版本进行SM2加密...');
                    // 确保WASM模块已正确加载
                    const wasmModule = await import('./build/codec_wasm.js');
                    if (wasmModule) {
                        const wasmEncryptedResult = wasmModule.sm2_encrypt(testData, testKey);
                        console.log('WASM加密结果:', wasmEncryptedResult);
                        wasmEncrypted.textContent = wasmEncryptedResult;
                        
                        const wasmDecryptedResult = wasmModule.sm2_decrypt(wasmEncryptedResult, testKey);
                        console.log('WASM解密结果:', wasmDecryptedResult);
                        wasmDecrypted.textContent = wasmDecryptedResult;
                    } else {
                        console.error('WASM模块未正确加载');
                        wasmEncrypted.textContent = '错误：WASM模块未正确加载';
                        wasmDecrypted.textContent = '错误：WASM模块未正确加载';
                    }
                } catch (error) {
                    console.error('WASM处理出错:', error);
                    wasmEncrypted.textContent = '错误：' + error.message;
                    wasmDecrypted.textContent = '错误：' + error.message;
                }
            } catch (error) {
                console.error('测试过程中发生错误:', error);
            } finally {
                runTestButton.disabled = false;
            }
        }

        runTestButton.addEventListener('click', runSM2Comparison);
        
        // 页面加载完成后初始化WASM模块
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initializeWasmModule();
                console.log('WASM模块已初始化');
            } catch (error) {
                console.error('初始化WASM模块失败:', error);
            }
        });
    </script>
</body>
</html>