# QPS限流配置使用说明

## 📋 功能概述

QPS限流配置是服务管理中的重要功能，用于控制API接口的访问频率，防止系统过载和恶意攻击。支持多种限流算法和灵活的配置策略。

## 🚀 快速开始

### 1. 访问配置页面

1. 进入 **服务管理** 页面
2. 选择需要配置的服务器
3. 在ServletFilter列表中找到 **QpsRateLimit** 类型的过滤器
4. 点击 **配置** 按钮打开QPS限流配置页面

### 2. 基础配置

#### 启用状态
- **开启**：启用QPS限流功能
- **关闭**：禁用QPS限流功能

#### 限流器类型
- **令牌桶 (token)**：基于令牌桶算法，支持突发流量
- **滑动窗口 (sliding)**：基于滑动窗口算法，平滑限流
- **Guava限流 (guava)**：基于Google Guava的RateLimiter

## ⚙️ 详细配置

### 限流阈值配置

#### 阈值设置
- **数值范围**：1 - 100,000
- **建议值**：
  - 低流量API：10-50 QPS
  - 中等流量API：100-500 QPS
  - 高流量API：1000+ QPS

#### 时间单位
- **每秒 (QPS)**：每秒请求数限制
- **每分钟 (QPM)**：每分钟请求数限制
- **每小时 (QPH)**：每小时请求数限制
- **每天 (QPD)**：每天请求数限制

### 拒绝策略配置

#### 策略类型

**限流惩罚 (LIMIT)**
- 超过阈值时临时限制访问
- 适用于正常用户的流量控制
- 支持自动恢复

**加入黑名单 (BLACKLIST)**
- 超过阈值时加入黑名单
- 适用于恶意攻击防护
- 需要手动移除

#### 惩罚配置

**惩罚时长格式**
```
30S    - 30秒
5MIN   - 5分钟
1H     - 1小时
1D     - 1天
```

**永久惩罚**
- 开启：永久限制访问
- 关闭：按时长限制访问

**惩罚阈值**
- 触发惩罚的请求数阈值
- 留空则使用限流阈值

### IP访问控制

#### 白名单配置
- **作用**：白名单IP不受限流限制
- **格式**：支持单个IP和CIDR网段
- **示例**：
  ```
  192.168.1.100      - 单个IP
  192.168.1.0/24     - 网段
  10.0.0.0/8         - 大网段
  ```

#### 黑名单配置
- **作用**：黑名单IP直接拒绝访问
- **优先级**：高于限流规则
- **格式**：同白名单格式

## 📊 配置示例

### 示例1：API接口限流
```json
{
  "enabled": true,
  "limiterType": "token",
  "threshold": 100,
  "timeUnit": "SECOND",
  "rejectStrategy": "LIMIT",
  "penaltyDuration": "30S",
  "penaltyPermanent": false,
  "penaltyThreshold": 120,
  "whitelistIps": ["192.168.1.0/24"],
  "blacklistIps": []
}
```

### 示例2：严格防护模式
```json
{
  "enabled": true,
  "limiterType": "sliding",
  "threshold": 50,
  "timeUnit": "MINUTE",
  "rejectStrategy": "BLACKLIST",
  "penaltyDuration": "1H",
  "penaltyPermanent": false,
  "penaltyThreshold": 60,
  "whitelistIps": ["127.0.0.1"],
  "blacklistIps": []
}
```

### 示例3：宽松限流模式
```json
{
  "enabled": true,
  "limiterType": "guava",
  "threshold": 1000,
  "timeUnit": "SECOND",
  "rejectStrategy": "LIMIT",
  "penaltyDuration": "10S",
  "penaltyPermanent": false,
  "penaltyThreshold": null,
  "whitelistIps": [],
  "blacklistIps": []
}
```

## 🔧 最佳实践

### 1. 阈值设置建议
- **测试环境**：设置较高阈值，便于测试
- **生产环境**：根据实际业务需求设置合理阈值
- **监控调优**：根据监控数据动态调整阈值

### 2. 策略选择建议
- **内部API**：使用限流惩罚策略
- **公开API**：使用黑名单策略
- **核心接口**：设置较严格的限流规则

### 3. IP控制建议
- **白名单**：添加内部网段和可信IP
- **黑名单**：添加已知恶意IP
- **定期清理**：定期清理过期的IP规则

### 4. 监控和告警
- **监控指标**：QPS、拒绝率、惩罚次数
- **告警设置**：异常流量、频繁触发限流
- **日志分析**：分析被限流的请求来源

## 🚨 注意事项

### 配置变更
- 配置保存后立即生效
- 建议在低峰期进行配置变更
- 重要变更前请备份原配置

### 性能影响
- 限流功能会增加少量延迟
- 建议根据服务器性能调整配置
- 监控系统资源使用情况

### 故障排查
- 检查配置是否正确
- 查看服务器日志
- 验证IP白名单设置
- 确认时间单位配置

## 📞 技术支持

如遇到问题，请联系技术支持团队或查看相关文档。
