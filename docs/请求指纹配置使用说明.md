# 请求指纹配置使用说明

## 📋 功能概述

请求指纹配置是一个强大的请求识别和去重功能，通过计算请求的唯一指纹来识别和处理重复请求。支持多种摘要算法和灵活的指纹内容配置，可用于请求去重、安全审计、缓存优化等场景。

## 🚀 快速开始

### 1. 访问配置页面

1. 进入 **服务管理** 页面
2. 选择需要配置的服务器
3. 在ServletFilter列表中找到 **RequestFingerprint** 类型的过滤器
4. 点击 **配置** 按钮打开请求指纹配置页面

### 2. 基础配置

#### 启用状态
- **开启**：启用请求指纹功能
- **关闭**：禁用请求指纹功能

#### 响应头名称
- **默认值**：`X-Request-Fingerprint`
- **作用**：指纹值将写入此响应头中
- **自定义**：可根据需要修改响应头名称

## ⚙️ 详细配置

### 指纹算法配置

#### 摘要算法选择
- **SHA-256**：推荐使用，安全性高，性能良好
- **SHA-1**：较快速度，安全性中等
- **MD5**：最快速度，安全性较低（不推荐用于安全敏感场景）
- **SHA-512**：最高安全性，速度较慢

#### 盐值配置
- **作用**：增加指纹的随机性和安全性
- **建议**：使用随机字符串作为盐值
- **示例**：`myapp-salt-2024`

### 指纹内容配置

#### 包含HTTP方法
- **开启**：指纹包含GET、POST、PUT等HTTP方法
- **场景**：区分不同类型的请求

#### 包含请求路径
- **开启**：指纹包含URL路径部分
- **场景**：区分不同的API接口

#### 包含请求参数
- **开启**：指纹包含查询参数和表单参数
- **场景**：区分相同接口的不同参数请求

#### 包含请求体
- **开启**：指纹包含POST/PUT请求的请求体
- **注意**：会增加计算开销，建议仅在必要时开启
- **场景**：需要区分相同接口不同请求体的场景

#### 包含请求头
- **配置**：选择参与指纹计算的请求头
- **常用请求头**：
  - `User-Agent`：区分不同客户端
  - `Content-Type`：区分不同内容类型
  - `Authorization`：区分不同用户
  - `X-Forwarded-For`：区分不同来源IP

### 去重配置

#### 有效期设置
- **范围**：0 - 86400秒（24小时）
- **0秒**：不进行去重，仅生成指纹
- **建议值**：
  - 短期去重：60-300秒
  - 中期去重：1800-3600秒（30分钟-1小时）
  - 长期去重：7200-86400秒（2-24小时）

#### 拦截重复请求
- **开启**：在有效期内遇到相同指纹时返回HTTP 409错误
- **关闭**：仅记录指纹，不拦截重复请求
- **响应**：拦截时返回`{"error":"Duplicate request"}`

## 📊 配置示例

### 示例1：API去重保护
```json
{
  "enabled": true,
  "headerName": "X-Request-Fingerprint",
  "algorithm": "SHA-256",
  "salt": "api-dedup-2024",
  "includeMethod": true,
  "includePath": true,
  "includeParams": true,
  "includeHeaders": ["Authorization"],
  "includeBody": false,
  "validityMs": 300000,
  "rejectDuplicate": true
}
```

### 示例2：请求审计记录
```json
{
  "enabled": true,
  "headerName": "X-Audit-ID",
  "algorithm": "SHA-1",
  "salt": "audit-log-salt",
  "includeMethod": true,
  "includePath": true,
  "includeParams": true,
  "includeHeaders": ["User-Agent", "X-Forwarded-For"],
  "includeBody": true,
  "validityMs": 0,
  "rejectDuplicate": false
}
```

### 示例3：缓存优化
```json
{
  "enabled": true,
  "headerName": "X-Cache-Key",
  "algorithm": "MD5",
  "salt": "",
  "includeMethod": true,
  "includePath": true,
  "includeParams": true,
  "includeHeaders": [],
  "includeBody": false,
  "validityMs": 1800000,
  "rejectDuplicate": false
}
```

## 🔧 最佳实践

### 1. 算法选择建议
- **高安全场景**：使用SHA-256或SHA-512
- **高性能场景**：使用SHA-1或MD5
- **平衡场景**：推荐SHA-256

### 2. 指纹内容建议
- **API去重**：包含方法、路径、参数、关键请求头
- **安全审计**：包含所有内容，包括请求体
- **缓存优化**：仅包含影响响应的内容

### 3. 去重策略建议
- **防刷接口**：短有效期（1-5分钟）+ 拦截重复
- **幂等保护**：中等有效期（10-30分钟）+ 拦截重复
- **日志分析**：长有效期或不去重 + 不拦截

### 4. 性能优化建议
- **避免包含大请求体**：会显著增加计算开销
- **合理选择请求头**：只包含必要的请求头
- **适当设置有效期**：避免内存占用过大

## 🚨 注意事项

### 配置变更
- 配置变更后会清理现有指纹缓存
- 建议在低峰期进行配置变更
- 重要变更前请备份原配置

### 性能影响
- 包含请求体会显著增加CPU使用
- 长有效期会增加内存使用
- 建议监控系统资源使用情况

### 安全考虑
- 盐值应保密，避免泄露
- 指纹值可能包含敏感信息
- 建议定期更换盐值

### 故障排查
- 检查算法是否支持
- 验证指纹内容配置
- 查看服务器错误日志
- 确认有效期设置合理

## 📈 监控指标

### 关键指标
- **指纹生成速率**：每秒生成的指纹数量
- **重复检测率**：检测到重复请求的比例
- **缓存命中率**：指纹缓存的命中情况
- **内存使用量**：指纹缓存占用的内存

### 告警设置
- **高重复率告警**：可能存在恶意攻击
- **内存使用告警**：缓存占用过多内存
- **性能下降告警**：指纹计算影响响应时间

## 📞 技术支持

如遇到问题，请联系技术支持团队或查看相关文档。
